# 第三章 研究方法

## 3.1 研究架構

本研究旨在建立一個基於縱貫性健康檢查資料的三高（高血壓、高血糖、高血脂）風險預測模型。研究架構如圖 3-1 所示，整體流程分為四個階段：資料前處理、特徵工程、模型建立與評估。

```
┌─────────────────────────────────────────────────────────────────┐
│                        原始健檢資料                               │
│                   （縱貫追蹤，每 2 年一次）                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      資料前處理                                   │
│  • 篩選符合條件的受檢者（至少 3 次健檢紀錄）                        │
│  • 轉換為寬表格式（Wide Format）                                  │
│  • 定義目標變數（T3 時間點的三高狀態）                             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        特徵工程                                   │
│  • T1 時間點特徵（基線值）                                        │
│  • T2 時間點特徵（最近一次健檢值）                                 │
│  • Δ 特徵（T2 - T1 變化量）                                      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       模型建立與評估                               │
│  • 訓練/測試集切分（80/20，分層抽樣）                              │
│  • 模型訓練（LR, XGBoost, 符號回歸）                              │
│  • 效能評估（AUC, Sensitivity, Specificity, F1）                 │
│  • 消融實驗（Δ 特徵、class_weight）                               │
│  • 可解釋性分析（SHAP）                                          │
└─────────────────────────────────────────────────────────────────┘
```

**圖 3-1 研究架構圖**

### 3.1.1 研究時間軸設計

本研究採用三個時間點的縱貫設計：

```
T1 ──────────→ T2 ──────────→ T3
   （約 2 年）      （約 2 年）

輸入特徵：X_T1, X_T2, Δ(T2-T1)
預測目標：Y_T3（是否罹患三高）
```

選擇 T3 而非 T2 作為預測目標的原因：

1. **避免資料洩漏**：若以 T2 為目標，T2 的健檢數據與疾病狀態來自同一次檢查，會造成模型「偷看答案」
2. **Δ 特徵可用**：以 T3 為目標，才能將 T2-T1 的變化量作為有效的預測因子
3. **臨床意義**：提供約 2 年的預警時間窗口，讓醫療人員有足夠時間進行早期介入

---

## 3.2 資料來源與處理

### 3.2.1 資料來源

本研究使用某醫療機構的縱貫性健康檢查資料，包含多次追蹤健檢紀錄的受檢者資料。

<!-- TODO: 補充具體資料來源說明 -->

### 3.2.2 樣本篩選

納入條件：
- 至少有 3 次以上的連續健檢紀錄
- 各時間點資料完整，無重大缺失

最終樣本數：**6,056 人**

### 3.2.3 變數定義

#### 人口學變數

| 變數 | 說明 | 單位/編碼 |
|------|------|-----------|
| sex | 性別 | 1=男, 2=女 |
| Age | 年齡 | 歲 |

#### 健檢指標

| 變數 | 全名 | 單位 | 臨床意義 |
|------|------|------|----------|
| BMI | Body Mass Index | kg/m² | 身體質量指數 |
| SBP | Systolic Blood Pressure | mmHg | 收縮壓 |
| DBP | Diastolic Blood Pressure | mmHg | 舒張壓 |
| FBG | Fasting Blood Glucose | mmol/L | 空腹血糖 |
| TC | Total Cholesterol | mmol/L | 總膽固醇 |
| Cr | Creatinine | μmol/L | 肌酐 |
| GFR | Glomerular Filtration Rate | mL/min/1.73m² | 腎絲球過濾率 |
| UA | Uric Acid | μmol/L | 尿酸 |

#### 目標變數定義

| 疾病 | 定義 | 編碼 |
|------|------|------|
| 高血壓（Hypertension） | SBP ≥ 140 mmHg 或 DBP ≥ 90 mmHg | 1=正常, 2=患病 |
| 高血糖（Hyperglycemia） | FBG ≥ 7.0 mmol/L | 1=正常, 2=患病 |
| 高血脂（Dyslipidemia） | TC ≥ 6.2 mmol/L | 1=正常, 2=患病 |

### 3.2.4 類別不平衡情況

| 疾病 | 患病率 | 負:正比例 | 不平衡程度 |
|------|--------|-----------|------------|
| 高血壓 | 16.68% | 5.0:1 | 輕度 |
| 高血糖 | 5.53% | 17.1:1 | 重度 |
| 高血脂 | 5.96% | 15.8:1 | 重度 |

---

## 3.3 特徵工程

### 3.3.1 特徵集設計

本研究使用的特徵分為三類：

| 特徵類別 | 說明 | 特徵數 |
|----------|------|--------|
| **基本資訊** | sex, Age | 2 |
| **T1 特徵** | FBG_T1, TC_T1, Cr_T1, UA_T1, GFR_T1, BMI_T1, SBP_T1, DBP_T1 | 8 |
| **T2 特徵** | FBG_T2, TC_T2, Cr_T2, UA_T2, GFR_T2, BMI_T2, SBP_T2, DBP_T2 | 8 |
| **Δ 特徵** | Delta1_FBG, Delta1_TC, Delta1_Cr, Delta1_UA, Delta1_GFR, Delta1_BMI, Delta1_SBP, Delta1_DBP | 8 |
| **合計** | | **26** |

### 3.3.2 Δ 特徵的意義

Δ 特徵代表 T2 與 T1 之間的變化量：

$$\Delta_i = X_{i,T2} - X_{i,T1}$$

Δ 特徵的設計理念：
- **捕捉動態趨勢**：某些疾病的發展不僅取決於當前數值，更取決於變化趨勢
- **正值代表上升**：例如 Delta1_FBG > 0 表示血糖在兩年間上升
- **負值代表下降**：例如 Delta1_GFR < 0 表示腎功能在兩年間下降

---

## 3.4 模型方法

### 3.4.1 Logistic Regression (LR)

Logistic Regression 是一種經典的線性分類模型，適用於二元分類問題。

**模型形式**：

$$P(Y=1|X) = \frac{1}{1 + e^{-(\beta_0 + \beta_1 X_1 + ... + \beta_n X_n)}}$$

**選用原因**：
- 可解釋性高：係數可直接解讀為風險因子的貢獻
- 計算效率高：適合作為基準模型
- 支援 class_weight：可處理類別不平衡問題

**實作參數**：
- `solver`: 'lbfgs'
- `max_iter`: 1000
- `class_weight`: 'balanced'（處理類別不平衡）

### 3.4.2 XGBoost

XGBoost (eXtreme Gradient Boosting) 是一種基於梯度提升的集成學習方法。

**演算法原理**：
透過逐步加入決策樹，每棵新樹專注於修正前面樹的預測誤差：

$$\hat{y}_i^{(t)} = \hat{y}_i^{(t-1)} + f_t(x_i)$$

**選用原因**：
- 預測效能強：在許多醫學預測任務中表現優異
- 可處理非線性關係：能捕捉特徵間的複雜交互作用
- 支援特徵重要性評估

**實作參數**：
- `n_estimators`: 100
- `max_depth`: 6
- `learning_rate`: 0.1
- `scale_pos_weight`: 自動計算（處理類別不平衡）

### 3.4.3 符號回歸 (Symbolic Regression)

符號回歸透過遺傳規劃（Genetic Programming）演化出可解釋的數學公式。

**演算法原理**：
1. 初始化：隨機生成一群數學公式（個體）
2. 評估：計算每個公式的預測誤差（適應度）
3. 選擇：保留表現較好的公式
4. 演化：透過交叉、突變產生新公式
5. 重複直到收斂

**選用原因**：
- 完全透明：產出的公式可直接理解
- 領域知識驗證：可檢驗公式是否符合醫學邏輯
- 輕量部署：簡單公式不需複雜運算資源

**使用套件**：
- **gplearn**：Python 原生，但不支援 class_weight
- **PySR**：基於 Julia，支援 sample_weight，效能更佳

### 3.4.4 類別不平衡處理

由於三高疾病的患病率較低（5-17%），本研究採用 class_weight 方法處理類別不平衡：

$$w_i = \frac{n_{samples}}{n_{classes} \times n_{samples_i}}$$

其中 $w_i$ 為第 $i$ 類的權重，$n_{samples}$ 為總樣本數，$n_{classes}$ 為類別數，$n_{samples_i}$ 為第 $i$ 類的樣本數。

**balanced 設定的效果**：
- 增加少數類（患病者）在損失函數中的權重
- 讓模型更注重正確識別患病者
- 提升 Sensitivity，但可能犧牲部分 Specificity

---

## 3.5 模型評估

### 3.5.1 資料切分

```python
X_train, X_test, y_train, y_test = train_test_split(
    X, y,
    test_size=0.2,          # 20% 作為測試集
    random_state=42,        # 固定隨機種子
    stratify=y              # 分層抽樣
)
```

| 資料集 | 樣本數 | 百分比 |
|--------|--------|--------|
| 訓練集 | 4,845 人 | 80% |
| 測試集 | 1,211 人 | 20% |
| 總計 | 6,056 人 | 100% |

### 3.5.2 評估指標

#### AUC-ROC (Area Under the ROC Curve)

ROC 曲線以 False Positive Rate 為 X 軸，True Positive Rate 為 Y 軸，AUC 為曲線下面積。

- AUC = 0.5：隨機猜測
- AUC = 0.7-0.8：可接受
- AUC = 0.8-0.9：良好
- AUC > 0.9：優秀

**特點**：與分類閾值無關，反映模型的整體排序能力。

#### Sensitivity（敏感度/召回率）

$$Sensitivity = \frac{TP}{TP + FN}$$

代表模型正確識別患病者的能力。在疾病篩檢中，高 Sensitivity 意味著較少漏診。

#### Specificity（特異度）

$$Specificity = \frac{TN}{TN + FP}$$

代表模型正確排除健康者的能力。高 Specificity 意味著較少誤診。

#### F1-Score

$$F1 = 2 \times \frac{Precision \times Recall}{Precision + Recall}$$

精確率與召回率的調和平均，適用於類別不平衡的情況。

#### 混淆矩陣

|  | 預測：患病 | 預測：健康 |
|--|-----------|-----------|
| **實際：患病** | True Positive (TP) | False Negative (FN) |
| **實際：健康** | False Positive (FP) | True Negative (TN) |

---

## 3.6 實驗設計

### 3.6.1 消融實驗

#### Δ 特徵消融實驗

目的：驗證 Δ 特徵對預測效能的貢獻

| 實驗組 | 特徵集 | 說明 |
|--------|--------|------|
| Full | T1 + T2 + Δ | 完整特徵集 |
| No-Δ | T1 + T2 | 移除 Δ 特徵 |
| T1-Only | T1 | 只用基線值 |
| T2-Only | T2 | 只用最近值 |
| Δ-Only | Δ | 只用變化量 |

#### class_weight 消融實驗

目的：驗證 class_weight 對 Sensitivity-Specificity 平衡的影響

| 實驗組 | 設定 | 說明 |
|--------|------|------|
| None | 無權重 | 原始分佈 |
| balanced | 自動平衡 | sklearn 預設 |
| 1:3 | 手動設定 | 正類權重為負類 3 倍 |
| 1:5 | 手動設定 | 正類權重為負類 5 倍 |
| 1:10 | 手動設定 | 正類權重為負類 10 倍 |

### 3.6.2 可解釋性分析

本研究使用 SHAP (SHapley Additive exPlanations) 進行模型可解釋性分析：

- **SHAP 值**：量化每個特徵對預測結果的貢獻
- **特徵重要性排序**：識別最具影響力的風險因子
- **交互效應**：分析特徵間的協同或拮抗作用

---

## 3.7 實驗環境

| 項目 | 規格 |
|------|------|
| 作業系統 | Windows 10/11 |
| 程式語言 | Python 3.10 |
| 主要套件 | scikit-learn, XGBoost, gplearn, PySR, SHAP |
| 開發環境 | Jupyter Notebook |

---

## 本章小結

本章說明了研究方法的設計，包括：

1. **研究架構**：採用三時間點縱貫設計，以 T3 為預測目標
2. **資料處理**：6,056 位受檢者，26 個特徵
3. **模型方法**：LR、XGBoost、符號回歸，搭配 class_weight 處理不平衡
4. **評估指標**：AUC、Sensitivity、Specificity、F1
5. **實驗設計**：Δ 消融、class_weight 消融、SHAP 可解釋性分析

下一章將呈現各項實驗的結果與分析。
