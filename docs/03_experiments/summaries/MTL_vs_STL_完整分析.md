# MTL vs STL 完整分析

> **建立日期**：2026-01-13
> **整合自**：MTL_vs_STL.md、MTL實驗保留與分析.md、MTL真偽辨析.md
> **狀態**：實驗完成

---

## 1. 概念介紹

### 1.1 健檢哲學與機器學習的對應

在實際健康檢查中，我們不可能「一次抽血只檢驗一個項目」。

| 概念 | 健檢實務 | 機器學習方法 |
|------|----------|--------------|
| **低效率做法** | 抽三管血，分別送三個實驗室 | STL：建三個獨立模型 |
| **高效率做法** | 抽一管血，同時檢驗多項指標 | MTL：建一個模型，多個輸出 |

### 1.2 STL（Single-Task Learning）

為每個預測目標建立獨立的模型。

```
輸入特徵 (X)
    │
    ├──► Model_HT ──► 高血壓預測 (y_HT)
    │
    ├──► Model_HG ──► 高血糖預測 (y_HG)
    │
    └──► Model_DL ──► 高血脂預測 (y_DL)
```

**特點**：
- 3 個獨立模型，各自訓練
- 無法捕捉疾病間的關聯
- 類比：三個專科醫生，各看各的病歷

### 1.3 MTL（Multi-Task Learning）

使用一個共享的模型架構，同時預測多個相關任務。

```
輸入特徵 (X)
    │
    ▼
┌─────────────────┐
│  Shared Layers  │  ← 學習共同的健康風險表示
│  (特徵共享層)    │
└─────────────────┘
    │
    ├──► Head_HT ──► 高血壓預測 (y_HT)
    │
    ├──► Head_HG ──► 高血糖預測 (y_HG)
    │
    └──► Head_DL ──► 高血脂預測 (y_DL)
```

**特點**：
- 1 個共享模型 + 3 個輸出頭
- 聯合訓練，任務間互相影響
- 類比：一個全科醫生，綜合判斷所有指標

---

## 2. 真 MTL vs 假 MTL

### 2.1 真 MTL：共享參數的多任務學習

**定義**：
- 模型底層參數在多個任務之間**共享**
- 只有最後的輸出層針對不同任務分開
- **訓練一次**，同時學習所有任務

**範例**：神經網路（PyTorch 實作）

```python
class MTLNetwork(nn.Module):
    def __init__(self, input_dim, hidden_dims=[64, 32], n_tasks=3):
        # 共享層
        self.shared = nn.Sequential(
            nn.Linear(input_dim, 64), nn.ReLU(),
            nn.Linear(64, 32), nn.ReLU()
        )
        # 任務專屬輸出頭
        self.heads = nn.ModuleList([
            nn.Linear(32, 1) for _ in range(n_tasks)
        ])
```

### 2.2 假 MTL：MultiOutputClassifier 包裝器

**定義**：
- 使用 `sklearn.multioutput.MultiOutputClassifier`
- **實際上還是訓練 3 個獨立模型**
- 沒有參數共享，只是包裝成統一介面

**範例**：LR, RF, XGBoost, SVM

```python
# 假 MTL：內部實際訓練 3 個獨立模型
mtl_model = MultiOutputClassifier(LogisticRegression())
mtl_model.fit(X_train, y_train_multi)

# 等價於
for i in range(3):
    model = LogisticRegression()
    model.fit(X_train, y_train_multi[:, i])  # 訓練 3 次！
```

### 2.3 分類總結

| 模型 | MTL 類型 | 參數共享 | 真/假 |
|------|----------|----------|:-----:|
| **PyTorch ANN** | 共享隱藏層 | ✅ | ✅ 真 |
| **sklearn ANN** | 共享隱藏層 | ✅ | ✅ 真 |
| **LR/RF/XGB/SVM** | MultiOutputClassifier | ❌ | ❌ 假 |

---

## 3. 實驗結果

### 3.1 新實驗（2026-01-13，滑動窗口資料）

使用 PyTorch 實作真 MTL，5-Fold CV with GroupKFold。

#### 效能比較

| Task | MTL AUC | STL AUC | 差異 | 結果 |
|------|---------|---------|------|------|
| **HTN** | 0.734 | 0.742 | -0.008 | STL 略勝 |
| **HG** | 0.932 | 0.933 | -0.001 | 持平 |
| **DL** | 0.868 | 0.869 | -0.001 | 持平 |
| **平均** | 0.845 | 0.848 | -0.003 | **幾乎相同** |

#### 訓練時間比較

| 方法 | 每 Fold 時間 | 加速比 |
|------|-------------|--------|
| MTL | 9.0 秒 | 1.21x 較快 |
| STL | 10.9 秒 | - |

### 3.2 舊實驗（2025-12，原始資料）

使用 sklearn MultiOutputClassifier（假 MTL）。

| 模型 | 高血壓 | 高血糖 | 高血脂 |
|------|--------|--------|--------|
| **RF Single-Task** | 0.796 | 0.892 | 0.868 |
| **RF MTL** | 0.787 | 0.914 | 0.873 |
| **差異** | -0.009 | **+0.022** | +0.005 |

### 3.3 結果一致性

兩次實驗結論一致：
- ✅ **效能差異極小**（< 1%）
- ✅ **時間優勢有限**（不是 3x，只有 1.2x）
- ✅ **結果穩健**：不同框架、不同資料格式，結論相同

---

## 4. 為什麼 MTL 沒有優勢？

### 4.1 共病分析結果

| 疾病對 | Odds Ratio | Phi 相關 | 解讀 |
|--------|-----------|----------|------|
| HTN ↔ HG | 1.72*** | 0.08 | 弱關聯 |
| HG ↔ DL | 1.39** | 0.05 | 很弱關聯 |
| HTN ↔ DL | 1.07 | 0.01 | 幾乎獨立 |

**結論**：三高之間的直接相關性很弱（Phi < 0.1），MTL 難以從任務間學到額外資訊。

### 4.2 理論解釋

MTL 的優勢來自：
1. **共享表徵**：任務相關時，共享層能學到通用特徵
2. **正則化效果**：多任務約束減少過擬合

但在我們的案例中：
- 三高疾病相關性弱 → 共享表徵價值低
- 資料量足夠（13,514 樣本）→ 不需要額外正則化
- 任務難度差異大（HG=0.93 vs HTN=0.74）→ 簡單任務可能干擾難任務

---

## 5. 論文撰寫建議

### 5.1 Method 段落

> 我們比較了兩種學習策略：
>
> 1. **Single-Task Learning (STL)**：為高血壓、高血糖、高血脂分別建立獨立的預測模型
> 2. **Multi-Task Learning (MTL)**：使用共享的神經網路隱藏層，同時預測三種疾病
>
> MTL 架構採用兩層共享隱藏層（64→32 neurons）加上三個任務專屬輸出頭。

### 5.2 Results 段落

> 表 X 展示了 MTL 與 STL 的比較結果。兩種方法在預測效能上幾乎相同（平均 AUC 差異 < 0.5%），MTL 在訓練時間上有 1.2 倍的加速。
>
> 這一結果與共病分析一致：三高疾病之間的直接相關性較弱（Phi < 0.1），限制了 MTL 透過共享表徵提升效能的空間。

### 5.3 Discussion 段落

> MTL 未能顯著超越 STL，這是一個**有價值的負面結果**。我們的分析顯示，MTL 的效益取決於任務間的相關性。當任務相關性弱、資料量充足時，獨立訓練的 STL 模型已足夠，MTL 的優勢主要體現在部署的便利性（單一模型）而非預測效能。

---

## 6. 相關檔案

### 實驗 Notebook
- [20_MTL_vs_STL.ipynb](../../../notebooks/experiments/20_MTL_vs_STL.ipynb)

### 實驗結果
- [mtl_vs_stl_results.csv](../../../results/mtl_vs_stl_results.csv)

### 背景知識
- [Comorbidity_Analysis.md](Comorbidity_Analysis.md) - 共病分析
- [三高共病關係科普.md](../../05_concepts/三高共病關係科普.md)

### 已歸檔（舊文件）
- [docs/archive/MTL真偽辨析.md](../../archive/MTL真偽辨析.md)
- [docs/archive/MTL計算效益補充程式碼.md](../../archive/MTL計算效益補充程式碼.md)

---

## 7. 總結

| 項目 | 結論 |
|------|------|
| **效能** | MTL ≈ STL（差異 < 1%） |
| **時間** | MTL 快 1.2x |
| **原因** | 三高相關性弱（Phi < 0.1） |
| **價值** | 有價值的負面結果，證明 MTL 適用條件 |
| **建議** | 在資料量充足且任務相關性弱時，STL 已足夠 |
