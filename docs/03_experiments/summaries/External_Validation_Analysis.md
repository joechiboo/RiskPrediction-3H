# Synthea 外部驗證分析

> **建立日期**：2026-01-13
> **更新日期**：2026-01-13
> **狀態**：驗證完成
> **結論**：僅高血壓可進行有限度的外部驗證，AUC 下降約 10-15%

---

## 1. 外部驗證目的

**核心問題**：不同的 dataset 執行相同的實驗，能不能得到相同的結論？

**驗證資料**：Synthea 合成醫療資料
- 來源：https://synthea.mitre.org/
- 總記錄：14,466 筆
- 患者數：1,158 人
- 平均每人記錄次數：12.5 次（具備多時間點資料）

---

## 2. 資料品質問題

### 2.1 缺失值概況

| 特徵 | Synthea 缺失率 | SUA 缺失率 | 影響疾病 |
|------|---------------|------------|----------|
| FBG（空腹血糖） | **69.0%** | 0% | 高血糖 |
| TC（總膽固醇） | **72.2%** | 0% | 高血脂 |
| UA（尿酸） | **100%** | 0% | - |
| BMI | 20.0% | 0% | 全部 |
| SBP/DBP | 0% | 0% | 高血壓 |

### 2.2 檢測偏差分析

Synthea 的資料生成邏輯導致嚴重的**檢測偏差 (Testing Bias)**：

#### FBG 記錄 vs 高血糖標籤

| 分類 | 有 FBG 記錄 | 沒有 FBG 記錄 | 總計 |
|------|------------|--------------|------|
| 高血糖=1 (正常) | **25** | 8,916 | 8,941 |
| 高血糖=2 (異常) | **4,465** | 1,060 | 5,525 |
| 總計 | 4,490 | 9,976 | 14,466 |

**發現**：Synthea 只對糖尿病/高血糖患者記錄 FBG，正常人幾乎沒有 FBG 記錄。

#### TC 記錄 vs 高血脂標籤

| 分類 | 有 TC | 沒有 TC |
|------|-------|---------|
| 高血脂比例 | **25.2%** | 9.8% |

**發現**：有 TC 記錄的人高血脂比例是沒有記錄的 2.5 倍，存在中度偏差。

---

## 3. 各疾病驗證可行性

### 3.1 高血糖 - ❌ 不可行

**原因**：極端選擇偏差

| 指標 | 數值 |
|------|------|
| 可用記錄 | 4,490 (31%) |
| 陽性比例 | **99.4%** |
| 陰性樣本 | 僅 25 筆 |

**結論**：有 FBG 的記錄中 99.4% 是高血糖患者，無法進行二元分類。這不是缺失值問題，而是 Synthea 資料生成邏輯本身的限制。

---

### 3.2 高血脂 - ⚠️ 有限度可行

**資料概況**：

| 指標 | 數值 |
|------|------|
| 可用記錄 | 4,018 (28%) |
| 有 ≥2 次記錄的患者 | 682 |
| 陽性比例 | 25.2% |
| SUA 陽性比例 | 7.9% |

**問題**：
- 陽性比例 25.2% 遠高於 SUA 的 7.9%
- 存在中度檢測偏差
- 樣本量較小

**結論**：技術上可行，但結果可比性存疑。

---

### 3.3 高血壓 - ✅ 可行（有限度）

**資料概況**：

| 指標 | Synthea | SUA |
|------|---------|-----|
| 可用記錄 | 11,571 (80%) | 13,514 |
| 有 ≥2 次記錄的患者 | 1,117 | 6,056 |
| 陽性比例 | 31.7% | 19.3% |

**特徵分佈比較**：

| 特徵 | Synthea | SUA | 差異 |
|------|---------|-----|------|
| 平均年齡 | 43.7 歲 | 68.1 歲 | **-24.4 歲** |
| 年齡 < 40 歲 | 42.4% | 0% | Synthea 含年輕人 |
| 年齡 ≥ 65 歲 | 22.7% | 62.7% | SUA 以老年為主 |
| BMI | 26.1 | 23.4 | +2.7 |
| SBP | 123.9 | 125.5 | -1.6 |
| DBP | 82.6 | 75.3 | +7.3 |

**主要問題**：年齡分佈差異極大（平均差 25 歲）

---

## 4. 高血壓外部驗證實驗

### 4.1 實驗設計

#### 方法一：簡化特徵（單一時間點）

- **訓練集**：SUA 全部資料（13,514 樣本）
- **測試集**：Synthea 完整記錄（11,571 樣本）
- **特徵**：Age, sex, BMI, SBP, DBP（5 個特徵）
- **模型**：LR, RF

#### 方法二：滑動窗口（多時間點，與 SUA 相同格式）

由於 Synthea 具備多時間點資料，可建立與 SUA 相同格式的滑動窗口：

- **Synthea 滑動窗口**：9,333 筆（來自 1,113 位患者）
- **共同特徵**：11 個
  - 基本：Age, sex
  - T1：BMI, SBP, DBP
  - T2：BMI, SBP, DBP
  - Delta：BMI, SBP, DBP
- **限制**：Synthea 缺少 FBG, TC, Cr, GFR, UA

### 4.2 實驗結果

#### 滑動窗口版本（11 個共同特徵）

| Model | SUA 5-Fold CV | Synthea (≥40歲) | 差異 |
|-------|---------------|-----------------|------|
| LR | 0.718 ± 0.018 | 0.625 | -0.094 |
| RF | 0.724 ± 0.012 | 0.605 | -0.119 |
| XGB | 0.704 ± 0.017 | 0.587 | -0.116 |

#### 年齡層分析

| 年齡層 | 樣本數 | 陽性率 | LR AUC | RF AUC |
|--------|--------|--------|--------|--------|
| ≥40 歲 | 5,576 | 41.9% | 0.625 | 0.605 |
| ≥50 歲 | 4,509 | 41.1% | 0.612 | 0.589 |
| ≥60 歲 | 2,991 | 43.2% | 0.606 | 0.581 |
| 60-80 歲 | 2,075 | 45.3% | 0.593 | 0.573 |

**SUA 參考**：LR=0.718, RF=0.724（相同 11 個特徵）

#### 與完整模型比較

| 特徵集 | Model | SUA AUC | 說明 |
|--------|-------|---------|------|
| 完整 26 特徵 | RF | **0.743** | SUA 最佳結果 |
| 共同 11 特徵 | RF | 0.724 | 缺少實驗室數據 |
| 外部驗證 | RF | 0.605 | Synthea ≥40歲 |

### 4.3 結果分析

1. **AUC 下降約 12%**（0.724 → 0.605）
   - 這是在「相同特徵格式」下的結果
   - 使用滑動窗口，包含 T1、T2、Delta 特徵

2. **年齡層匹配無法改善**
   - 即使篩選到 60-80 歲（最接近 SUA 的 68 歲），AUC 仍為 0.57-0.59
   - 說明差異不只是年齡問題

3. **可能原因**
   - Synthea 是合成資料，特徵關係可能與真實資料不同
   - 高血壓盛行率差異（42% vs 19%）
   - BMI、DBP 分佈差異

4. **缺少關鍵特徵的影響**
   - SUA 完整 26 特徵：AUC 0.743
   - SUA 共同 11 特徵：AUC 0.724（-0.02）
   - 實驗室數據（FBG, TC, Cr, GFR, UA）對高血壓貢獻約 2%

### 4.4 結論

高血壓外部驗證**技術上可行**，但效能下降明顯：
- 效能下降約 10-15%（AUC 0.72 → 0.60）
- 即使年齡層匹配，AUC 仍偏低
- 可能是 Synthea 合成資料的特性限制
- 這是「domain shift」的典型表現

---

## 5. 總結

### 5.1 外部驗證可行性總表

| 疾病 | 可行性 | 原因 |
|------|--------|------|
| **高血壓** | ✅ 可行（有限度） | 資料完整，但年齡分佈差異大 |
| **高血脂** | ⚠️ 有限度 | 中度檢測偏差，陽性比例偏高 |
| **高血糖** | ❌ 不可行 | 極端選擇偏差（99.4% 陽性） |

### 5.2 論文建議

#### 若選擇納入高血壓外部驗證

> **Results 段落**：
>
> 為評估模型的泛化能力，我們使用 Synthea 合成醫療資料進行外部驗證。由於 Synthea 資料中空腹血糖（FBG）和總膽固醇（TC）缺失率高達 70%，且存在嚴重選擇偏差（有 FBG 記錄的樣本中 99% 為高血糖），僅針對高血壓進行驗證。
>
> 我們將 Synthea 資料轉換為與 SUA 相同的滑動窗口格式（T1、T2、Delta 特徵），使用 11 個共同特徵進行驗證。在 Synthea ≥40 歲樣本上，Logistic Regression 達到 AUC 0.625，Random Forest 達到 AUC 0.605，相較於內部驗證（LR=0.718, RF=0.724）下降約 10-12%。
>
> 進一步分析發現，即使篩選與 SUA 年齡分佈相近的 60-80 歲樣本，AUC 仍維持在 0.57-0.59，顯示效能下降不僅是年齡差異所致，可能與 Synthea 合成資料的特性有關。此結果反映了模型在不同資料來源間的 domain shift 現象。

#### 若選擇不納入外部驗證

> **Discussion - 研究限制段落**：
>
> 本研究嘗試使用 Synthea 合成醫療資料進行外部驗證。然而，Synthea 資料存在以下限制：(1) 關鍵特徵（FBG、TC、GFR）缺失率高達 70%；(2) 有 FBG 記錄的樣本中 99% 為高血糖患者，存在嚴重選擇偏差，無法驗證高血糖模型；(3) 年齡分佈與本研究資料差異顯著（Synthea 平均 44 歲 vs SUA 68 歲）。
>
> 針對高血壓進行的有限度驗證顯示，模型 AUC 從內部驗證的 0.72 下降至外部驗證的 0.60-0.63，反映了 domain shift 的影響。未來研究可考慮申請實際醫療資料（如 MJ Health）進行更完整的外部驗證。

---

## 6. 相關檔案

### 資料檔案

- `data/01_primary/Synthea/Synthea_SUA_format.csv` - 原始格式
- `data/01_primary/Synthea/Synthea_sliding_window.csv` - 滑動窗口格式

### 參考文件

- [external_data_sources.md](../../01_data/external_data_sources.md) - 外部資料來源說明
- [Synthea_Dataset_Summary.md](../../06_datasets/Synthea/Synthea_Dataset_Summary.md) - Synthea 資料集摘要
