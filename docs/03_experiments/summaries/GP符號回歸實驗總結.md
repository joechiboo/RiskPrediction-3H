# GP 符號回歸實驗總結

> **建立日期**：2025-12-17
> **更新日期**：2026-01-12（新增 5-Fold CV 結果與未來調參方向）
> **實驗 Notebook**：`11_GP_Parameter_Tuning.ipynb`, `12_PySR_Experiment.ipynb`, `13_5FoldCV_Model_Comparison.ipynb`
> **狀態**：持續更新

---

## 1. 實驗背景

### 1.1 符號回歸的價值

符號回歸（Symbolic Regression）透過遺傳規劃（GP）演化出**可解釋的數學公式**：

- **完全透明**：產出的公式可直接理解
- **領域知識驗證**：可檢驗公式是否符合醫學邏輯
- **輕量部署**：簡單公式不需複雜運算

### 1.2 實驗目標

根據教授建議，測試 GP 參數調整與替代套件（PySR）能否改善預測效能。

---

## 2. 實驗過程與結果

### 2.1 實驗 1：gplearn 參數調整

依教授建議調整參數：
- `generations`: 20 → 100
- `tournament_size`: 20 → 2

#### 高血壓參數比較

| 配置 | AUC | F1 | Recall | 訓練時間 |
|------|-----|-----|--------|----------|
| 原始 (gen=20, ts=20) | **0.745** | 0.0 | 0.0 | 2.0 分鐘 |
| 調整 (gen=20, ts=2) | 0.704 | 0.0 | 0.0 | 2.0 分鐘 |
| 調整 (gen=50, ts=2) | 0.500 | 0.0 | 0.0 | 4.2 分鐘 |
| 調整 (gen=100, ts=2) | 0.544 | 0.0 | 0.0 | 9.0 分鐘 |

> ⚠️ **觀察**：原始參數 (gen=20, ts=20) 反而比調整後更好！

#### 三疾病最終結果 (gen=100, ts=2)

| 疾病 | AUC | F1 | Recall | 公式 | TP/FN |
|------|-----|-----|--------|------|-------|
| 高血壓 | 0.544 | 0.0 | 0.0 | `min(log(-0.227), X8)` | 0/202 ❌ |
| **高血糖** | **0.938** ⭐ | **0.569** | **0.500** | `add(add(log(0.019), X10), X10)` | 39/78 ✅ |
| 高血脂 | 0.832 | 0.027 | 0.014 | `add(log(-0.032), X11)` | 1/72 |

#### gplearn 結論

- **高血糖成功！** AUC=0.938 **超越 LR (0.931)**
- **高血壓/高血脂失敗**：公式退化，TP 接近 0
- **原因**：gplearn 不支援 `class_weight`，高血糖訊號強所以成功

#### ⏸️ 擱置決定

> **gplearn 擱置，改用 PySR 作為主要符號回歸工具**
>
> 理由：PySR (niterations=100) 已解決高血壓問題 (AUC=0.745)，三個疾病都能產出有意義的公式，無需繼續調整 gplearn。

### 2.2 實驗 2：PySR 替代方案

初次執行發現兩個 Bug：

| Bug | 問題 | 修正 |
|-----|------|------|
| **Bug 1** | X/y index 不對齊（迴圈只保留最後一次分割的 X） | 統一做一次資料分割 |
| **Bug 2** | `sample_weight='balanced'` 讓加權 y 期望值=0.5，PySR 用 MSE loss 會學到預測常數 0.5 | 移除 sample_weight |

### 2.3 關鍵改進：增加迭代次數

| 參數 | 原本 | 調整後 |
|------|------|--------|
| `niterations` | 40 | **100** |
| `timeout` | 300s | 600s |

**結果**：高血壓從 AUC=0.500 提升到 **AUC=0.745**！

---

## 3. 最終實驗結果（niterations=100）

### 3.1 效能比較

| 疾病 | gplearn | PySR | LR | XGBoost | PySR vs LR |
|------|---------|------|-----|---------|------------|
| **高血壓** | 0.500 | **0.745** ✅ | 0.749 | 0.795 | -0.004 (幾乎相同) |
| **高血糖** | 0.501 | **0.943** ✅ | 0.931 | 0.903 | **+0.012** (超越!) |
| **高血脂** | 0.835 | 0.801 | 0.888 | 0.886 | -0.087 |

### 3.2 PySR 演化公式

| 疾病 | 公式 | 醫學意義 |
|------|------|----------|
| **高血壓** | `0.106 × exp(SBP_T1)` | ✅ 收縮壓越高，風險指數增長 |
| **高血糖** | `0.116 × FBG_T2` | ✅ 空腹血糖越高，風險越高 |
| **高血脂** | `0.052 × exp(TC_T1)` | ✅ 總膽固醇越高，風險指數增長 |

**三個疾病都學到有意義的公式！**

### 3.3 執行時間與混淆矩陣（PySR, niterations=100）

| 疾病 | AUC | 訓練時間 | 公式 | TP/FN | Recall |
|------|-----|----------|------|-------|--------|
| 高血壓 | 0.745 | **10.8 分鐘** | `0.106×exp(SBP_T1)` | 138/64 | 68.3% |
| 高血糖 | 0.943 | **10.1 分鐘** | `0.116×FBG_T2` | 72/6 | 92.3% |
| 高血脂 | 0.801 | **10.5 分鐘** | `0.052×exp(TC_T1)` | 65/8 | 89.0% |
| **總計** | - | **~31 分鐘** | - | - | - |

### 3.4 迭代次數 vs 時間估算

| niterations | 單疾病時間 | 三疾病總時間 | 備註 |
|-------------|-----------|-------------|------|
| 40 | ~4 分鐘 | ~12 分鐘 | 高血壓失敗 |
| **100** | ~10 分鐘 | **~31 分鐘** | ✅ 建議設定 |
| 200 | ~21 分鐘 | ~62 分鐘 | ✅ 已測試，無提升 |
| 500 | ~50 分鐘 | ~2.5 小時 | |

> **估算依據**：PySR 時間大致與 niterations 成線性關係

### 3.5 niterations=200 實驗結果

| 疾病 | 100 次 AUC | 200 次 AUC | 變化 | 公式 |
|------|------------|------------|------|------|
| 高血壓 | 0.745 | 0.745 | 無變化 | `0.130 × exp(SBP_T1)` |
| 高血糖 | 0.943 | 0.943 | 無變化 | `0.114 × FBG_T2` |
| 高血脂 | 0.801 | 0.801 | 無變化 | `0.043 × exp(TC_T1)` |

**結論**：
- 200 次迭代沒有提升 AUC，**100 次已經足夠**
- 公式結構相同，僅係數微調
- 高血脂 AUC=0.801 可能是符號回歸的上限（vs LR 0.888）

---

## 4. 分析與結論

### 4.1 為何高血壓需要更多迭代？

| 疾病 | 40 次 AUC | 100 次 AUC | 公式複雜度 |
|------|-----------|------------|-----------|
| 高血糖 | 0.943 | 0.943 | 簡單（線性）|
| 高血脂 | 0.801 | 0.801 | 中等（指數）|
| **高血壓** | 0.500 | **0.745** | 較複雜（指數）|

**原因分析**：
1. **高血糖**：`FBG_T2` 訊號強，40 次就找到
2. **高血壓**：需要 `exp(SBP_T1)` 非線性關係，搜尋空間更大
3. **教授建議正確**：增加 generations 對複雜問題有效

### 4.2 公式的醫學意義

**高血壓**：`0.106 × exp(SBP_T1)`
- SBP（收縮壓）是高血壓的直接指標
- 使用指數函數：高血壓風險隨 SBP 非線性增長
- 與 SHAP 分析一致：SBP_T1 是最重要特徵

**高血糖**：`0.116 × FBG_T2`
- FBG（空腹血糖）是糖尿病的核心指標
- 線性關係：血糖越高，風險越高
- 極簡公式，AUC 卻超越 LR 和 XGBoost

**高血脂**：`0.052 × exp(TC_T1)`
- TC（總膽固醇）是高血脂的核心指標
- 指數函數放大高 TC 的風險
- AUC 略低於 LR，但公式更直觀

---

## 5. 結論與建議

### 5.1 核心發現

| 發現 | 說明 |
|------|------|
| **gplearn 不適用** | 不支援 class_weight，類別不平衡下必然失敗 |
| **PySR 全面成功** | 三個疾病都學到有意義的公式 |
| **迭代次數很重要** | 高血壓需要 100 次才成功，40 次不夠 |
| **效能接近 LR** | 高血壓/高血糖 AUC 與 LR 相當或超越 |

### 5.2 實務建議

| 用途 | 建議方法 |
|------|---------|
| **預測效能優先** | XGBoost（高血壓最佳）或 LR |
| **可解釋性需求** | **PySR 公式**（三個疾病都可用）|
| **論文呈現** | PySR 公式可作為主要可解釋性結果 |
| **臨床部署** | 高血糖公式極簡，可直接使用 |

### 5.3 三個公式的亮點

```text
高血壓風險 = 0.106 × exp(SBP_T1)    # AUC=0.745
高血糖風險 = 0.116 × FBG_T2         # AUC=0.943 ⭐
高血脂風險 = 0.052 × exp(TC_T1)     # AUC=0.801
```

這些公式：
- **極簡**：每個只用一個特徵
- **可解釋**：符合醫學直覺
- **效能佳**：接近或超越 LR
- **可部署**：不需複雜模型

### 5.4 重要發現：教授建議驗證成功

> **增加迭代次數（40→100）讓高血壓 AUC 從 0.500 提升到 0.745**

這說明：
1. **複雜問題需要更多探索時間**
2. **教授建議增加 generations 是對的**
3. **PySR 在足夠迭代下能找到好公式**

---

## 6. 5-Fold CV 驗證結果（2026-01-12 更新）

### 6.1 單次實驗 vs 5-Fold CV 比較

| 疾病 | 單次實驗 AUC | 5-Fold CV AUC | 變化 | LR (5-Fold) |
|:----:|:-----------:|:-------------:|:----:|:-----------:|
| 高血壓 | 0.745 | 0.684 ±0.093 | **-0.061** ↓ | 0.754 |
| **高血糖** | **0.943** | 0.842 ±0.171 | **-0.101** ↓↓ | 0.932 |
| 高血脂 | 0.801 | 0.756 ±0.130 | **-0.045** ↓ | 0.867 |

### 6.2 關鍵發現

⚠️ **單次實驗結論需修正**：

| 原本結論 | 修正後 |
|:--------|:------|
| 高血糖 PySR (0.943) **超越** LR (0.931) | 5-Fold CV 顯示 PySR (0.842) **低於** LR (0.932) |
| PySR 效能接近 LR | PySR 效能低於 LR，且變異性極高 |

### 6.3 PySR 不穩定性分析

| 模型 | 平均 std | 穩定性評價 |
|:----:|:--------:|:--------:|
| LR | 0.012 | ⭐ 極穩定 |
| RF | 0.014 | ⭐ 極穩定 |
| XGB | 0.015 | ⭐ 極穩定 |
| **PySR** | **0.131** | ❌ 不穩定 |

**原因分析**：
- PySR 是隨機搜尋演算法，每次執行結果不同
- 目前公式深度太淺（單一特徵），搜尋空間受限
- 某些 fold 可能找到常數解（AUC≈0.5）

### 6.4 結論修正

| 項目 | 修正前 | 修正後 |
|:----:|:------|:------|
| PySR 定位 | 效能接近/超越 LR | **可解釋性工具**，效能次於 LR |
| 論文呈現 | 主要可解釋性結果 | **補充說明**，公式作為附錄 |
| 高血糖公式 | 超越 LR 的亮點 | 單次實驗幸運結果，不具代表性 |

---

## 7. 未來調參方向

### 7.1 當前問題：公式深度太淺

目前三個公式都是**單一特徵**：
```text
高血壓：0.106 × exp(SBP_T1)      # 深度=1
高血糖：0.116 × FBG_T2           # 深度=1
高血脂：0.052 × exp(TC_T1)       # 深度=1
```

**問題**：無法捕捉多特徵交互作用，限制預測能力。

### 7.2 建議調參方向

| 參數 | 目前值 | 建議調整 | 預期效果 |
|:----:|:-----:|:-------:|:--------|
| `maxsize` | 20 | **30-40** | 允許更複雜公式 |
| `niterations` | 100 | **200-400** | 更充分搜尋 |
| `populations` | 15 | **20-30** | 增加多樣性 |
| `binary_operators` | +,-,*,/ | 加入 `pow` | 允許冪次關係 |
| `complexity_of_operators` | 預設 | 調低 exp/log 複雜度 | 鼓勵非線性 |

### 7.3 期望改進

如果公式能達到**深度=2-3**，例如：
```text
# 期望的更複雜公式
高血壓：a × SBP_T1 + b × exp(Age) + c × BMI_T2
高血糖：a × FBG_T2 × (1 + b × BMI_T1)
高血脂：a × TC_T1 + b × TG_T2 / HDL_T1
```

**預期效果**：
- AUC 提升 0.05-0.10
- 變異性降低（更穩定的公式結構）
- 仍保持可解釋性

### 7.4 實驗優先度

| 優先度 | 調參實驗 | 理由 |
|:-----:|:--------|:----|
| 高 | maxsize=30-40 | 直接影響公式複雜度 |
| 中 | niterations=200-400 | 已測試 200 無提升，但搭配 maxsize 可能有效 |
| 低 | populations 調整 | 影響較小 |

---

## 8. 相關文件

- [11_GP_Parameter_Tuning.ipynb](../../notebooks/experiments/11_GP_Parameter_Tuning.ipynb)
- [12_PySR_Experiment.ipynb](../../notebooks/experiments/12_PySR_Experiment.ipynb)
- [13_5FoldCV_Model_Comparison.ipynb](../../notebooks/experiments/13_5FoldCV_Model_Comparison.ipynb)
- [GP參數調整建議.md](GP參數調整建議.md)
- [GP套件替代方案研究.md](GP套件替代方案研究.md)
