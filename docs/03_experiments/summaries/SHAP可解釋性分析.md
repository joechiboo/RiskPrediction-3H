# SHAP 可解釋性分析

> **建立日期**：2025-12-16
> **實驗 Notebook**：`08_SHAP_Analysis.ipynb`
> **狀態**：已完成

---

## 1. 什麼是 SHAP？

**SHAP (SHapley Additive exPlanations)** 是一種基於賽局理論的模型解釋方法。

### 核心概念

- **Shapley 值**：源自合作賽局理論，計算每個「玩家」（特徵）對「報酬」（預測結果）的貢獻
- **公平分配**：滿足數學上的公平性保證（效率性、對稱性、虛擬性、可加性）
- **局部解釋**：每個樣本都有自己的 SHAP 值，可解釋單一預測

### 為什麼選擇 SHAP？

| 方法 | 優點 | 缺點 |
|------|------|------|
| **SHAP** | 理論基礎扎實、一致性保證、局部+全域解釋 | 計算量大 |
| Permutation Importance | 簡單快速 | 不穩定、無法解釋單一樣本 |
| LIME | 局部解釋直觀 | 不穩定、缺乏全域視角 |
| 模型內建重要性 | 快速 | 不同模型不可比較 |

---

## 2. 實驗設計

### 分析對象

使用 **XGBoost** 模型進行 SHAP 分析（三種疾病）：
- 高血壓：AUC = 0.795
- 高血糖：AUC = 0.903
- 高血脂：AUC = 0.886

### 特徵集（26 個特徵）

| 類別 | 特徵 | 數量 |
|------|------|------|
| 人口統計 | sex, Age | 2 |
| Y-2 特徵 | FBG_Y-2, TC_Y-2, Cr_Y-2, UA_Y-2, GFR_Y-2, BMI_Y-2, SBP_Y-2, DBP_Y-2 | 8 |
| Y-1 特徵 | FBG_Y-1, TC_Y-1, Cr_Y-1, UA_Y-1, GFR_Y-1, BMI_Y-1, SBP_Y-1, DBP_Y-1 | 8 |
| Δ 變化量 | ΔFBG, ΔTC, ΔCr, ΔUA, ΔGFR, ΔBMI, ΔSBP, ΔDBP | 8 |

---

## 3. 關鍵發現

### 3.1 各疾病 Top 5 重要特徵

#### 高血壓

| 排名 | 特徵 | SHAP 值 | 解釋 |
|------|------|---------|------|
| 1 | **SBP_Y-2** | 0.924 | Y-2 收縮壓（最重要！）|
| 2 | SBP_Y-1 | 0.363 | Y-1 收縮壓 |
| 3 | ΔSBP | 0.224 | 收縮壓變化量 |
| 4 | GFR_Y-2 | 0.210 | Y-2 腎功能 |
| 5 | DBP_Y-2 | 0.139 | Y-2 舒張壓 |

**結論**：血壓相關特徵（SBP、DBP）主導預測，符合臨床直覺。

#### 高血糖

| 排名 | 特徵 | SHAP 值 | 解釋 |
|------|------|---------|------|
| 1 | **FBG_Y-1** | 2.383 | Y-1 空腹血糖（最重要！）|
| 2 | FBG_Y-2 | 0.875 | Y-2 空腹血糖 |
| 3 | ΔFBG | 0.254 | 血糖變化量 |
| 4 | ΔTC | 0.204 | 膽固醇變化量 |
| 5 | TC_Y-2 | 0.181 | Y-2 總膽固醇 |

**結論**：血糖相關特徵（FBG）主導預測，Y-1 時間點最重要。

#### 高血脂

| 排名 | 特徵 | SHAP 值 | 解釋 |
|------|------|---------|------|
| 1 | **TC_Y-1** | 1.420 | Y-1 總膽固醇（最重要！）|
| 2 | TC_Y-2 | 0.900 | Y-2 總膽固醇 |
| 3 | Age | 0.237 | 年齡 |
| 4 | ΔGFR | 0.202 | 腎功能變化量 |
| 5 | ΔTC | 0.161 | 膽固醇變化量 |

**結論**：膽固醇相關特徵（TC）主導預測，年齡也有顯著影響。

---

### 3.2 特徵類別重要性比較

| 類別 | 高血壓 | 高血糖 | 高血脂 |
|------|--------|--------|--------|
| Y-2 特徵 | **1.52** | 1.65 | 1.57 |
| Y-1 特徵 | 0.79 | **3.07** | **2.16** |
| Δ 變化量 | 0.73 | 1.09 | 0.98 |
| 人口統計 | 0.06 | 0.18 | 0.25 |

**關鍵發現**：

1. **高血壓**：Y-2 特徵最重要（1.52）
   - SBP_Y-2 單獨貢獻 0.92，佔 Y-2 總重要性的 60%
   - 說明「初始血壓」是預測高血壓的關鍵

2. **高血糖/高血脂**：Y-1 特徵最重要（3.07 / 2.16）
   - FBG_Y-1、TC_Y-1 是最強預測因子
   - 說明「最近一次檢測值」更能預測未來風險

3. **Δ 變化量**：有額外貢獻但非主導
   - 說明「趨勢」有價值，但「絕對值」更重要

---

### 3.3 單一樣本解釋（Waterfall Plot）

#### 高風險樣本（預測機率 = 0.959）

主要推升風險的特徵：
- SBP_Y-2 = 高 → 大幅增加風險
- SBP_Y-1 = 高 → 增加風險
- ΔSBP = 正（血壓上升）→ 增加風險

#### 低風險樣本（預測機率 = 0.005）

主要降低風險的特徵：
- SBP_Y-2 = -3.2（標準化後，表示低於平均）→ 大幅降低風險
- SBP_Y-1 = -2.5 → 降低風險
- 所有特徵都指向「低風險」

---

## 4. 臨床意義

### 4.1 驗證模型合理性

SHAP 分析結果符合醫學常識：
- **高血壓** ← 血壓（SBP、DBP）
- **高血糖** ← 血糖（FBG）
- **高血脂** ← 膽固醇（TC）

這驗證了模型學到了「正確的」特徵關係，而非雜訊。

### 4.2 臨床決策支援

Waterfall 圖可以回答：「為什麼這個病人被預測為高風險？」

例如：「此病人高血壓風險高，主要因為：
1. Y-2 收縮壓 145 mmHg（高於正常）
2. Y-1 收縮壓 150 mmHg（持續偏高）
3. 血壓呈上升趨勢（+5 mmHg）」

### 4.3 健檢重點建議

根據 SHAP 重要性排名，建議優先關注：

| 疾病 | 重點檢測項目 |
|------|------------|
| 高血壓 | 收縮壓、舒張壓、腎功能（GFR）|
| 高血糖 | 空腹血糖、膽固醇 |
| 高血脂 | 總膽固醇、年齡、腎功能變化 |

---

## 5. 產出檔案

### 圖片（`docs/experiments/`）

| 檔案 | 說明 |
|------|------|
| `shap_hypertension_importance.png` | 高血壓特徵重要性排名 |
| `shap_hypertension_beeswarm.png` | 高血壓蜂群圖 |
| `shap_hypertension_dependence.png` | 高血壓依賴圖 |
| `shap_hypertension_waterfall_high.png` | 高血壓高風險樣本解釋 |
| `shap_hypertension_waterfall_low.png` | 高血壓低風險樣本解釋 |
| `shap_hyperglycemia_summary.png` | 高血糖 SHAP 摘要 |
| `shap_dyslipidemia_summary.png` | 高血脂 SHAP 摘要 |
| `shap_comparison_all_diseases.png` | 三種疾病特徵重要性比較 |
| `shap_category_importance.png` | 特徵類別重要性比較 |

### 數據（`results/`）

| 檔案 | 說明 |
|------|------|
| `shap_feature_importance.csv` | 完整特徵重要性表格 |
| `08_SHAP_Analysis_output.txt` | Notebook 執行結果 |

---

## 6. 技術備註

### SHAP 計算方法

- 使用 `shap.TreeExplainer`（針對樹模型優化）
- 計算測試集（1,212 人）的 SHAP 值
- 時間複雜度：O(TLD²)，T=樹數量，L=葉子數，D=深度

### 已知問題

- Waterfall 圖的負號顯示為方框（matplotlib 字型問題）
- 解決方案：使用英文標籤或更換字型

---

## 7. 結論

1. **SHAP 驗證了模型的合理性**：每種疾病都是對應的生理指標最重要
2. **Y-1 特徵通常比 Y-2 重要**：最近的檢測值更能預測未來風險
3. **Δ 變化量有額外貢獻**：但不如絕對值重要
4. **SHAP 可用於臨床解釋**：Waterfall 圖能解釋單一病人的風險因素

---

**相關文件**：
- [08_SHAP_Analysis.ipynb](../../notebooks/experiments/08_SHAP_Analysis.ipynb)
- [shap_feature_importance.csv](../../results/shap_feature_importance.csv)
