# 實驗總覽

> **建立日期**：2026-01-13
> **目的**：彙整所有實驗的目的、方法與結論

---

## 實驗架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                      資料準備階段                            │
├─────────────────────────────────────────────────────────────┤
│  01_EDA → 02_DataPreprocessing → 滑動窗口格式               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      核心實驗                                │
├─────────────────────────────────────────────────────────────┤
│  17_基準模型比較 → 19_SHAP 可解釋性 → 20_MTL vs STL        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      消融實驗 (Ablation)                     │
├─────────────────────────────────────────────────────────────┤
│  10_ClassWeight → 21_Delta 特徵                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      進階實驗（探索性）                       │
├─────────────────────────────────────────────────────────────┤
│  12-18_PySR 符號回歸 → 22_Synthea 外部驗證（待做）          │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心實驗

### 17. 滑動窗口基準模型比較 ⭐

| 項目 | 內容 |
|------|------|
| **檔案** | `17_SlidingWindow_5FoldCV.ipynb` |
| **目的** | 比較 LR、RF、XGBoost 在三高預測的效能 |
| **方法** | 5-Fold CV with StratifiedGroupKFold（防止資料洩漏） |
| **資料** | 滑動窗口格式，13,514 樣本，6,056 病患 |
| **假說** | H4：可解釋模型（LR）效能接近黑盒模型 |

**結論**：

| 疾病 | 最佳模型 | AUC | 結論 |
|------|---------|-----|------|
| 高血壓 | RF | 0.743 | 較難預測 |
| 高血糖 | LR | 0.938 | LR 表現最佳 |
| 高血脂 | LR | 0.869 | LR 表現最佳 |

**關鍵發現**：LR 在 2/3 疾病上表現最佳，證明簡單模型足夠。

---

### 19. SHAP 可解釋性分析 ⭐

| 項目 | 內容 |
|------|------|
| **檔案** | `19_SHAP_SlidingWindow.ipynb` |
| **目的** | 分析各特徵對預測的貢獻 |
| **方法** | SHAP TreeExplainer（基於 RF 模型） |
| **假說** | 了解哪些特徵最重要 |

**結論**：

| 疾病 | Top 3 重要特徵 |
|------|---------------|
| 高血壓 | SBP_Y-1, Age, BMI_Y-1 |
| 高血糖 | FBG_Y-1, FBG_Y-2, Delta_FBG |
| 高血脂 | TC_Y-1, TC_Y-2, Delta_TC |

**關鍵發現**：
- Y-1 時間點的指標最重要（最接近預測目標）
- Delta 特徵在 Top 5 中出現，證明變化量有價值
- 符合臨床直覺（血壓預測看 SBP，血糖看 FBG）

---

### 20. MTL vs STL 比較 ⭐

| 項目 | 內容 |
|------|------|
| **檔案** | `20_MTL_vs_STL.ipynb` |
| **目的** | 比較多任務學習與單任務學習 |
| **方法** | PyTorch 神經網路，共享隱藏層 vs 獨立模型 |
| **假說** | H3：MTL 能利用疾病相關性，優於 STL |

**結論**：

| 方法 | HTN | HG | DL | 平均 | 訓練時間 |
|------|-----|----|----|------|---------|
| MTL | 0.734 | 0.932 | 0.868 | 0.845 | 9.0s |
| STL | 0.742 | 0.933 | 0.869 | 0.848 | 10.9s |

**關鍵發現**：
- MTL 與 STL 效能幾乎相同（差異 < 1%）
- 原因：三高相關性弱（Phi < 0.1）
- 這是**有價值的負面結果**

---

## 消融實驗

### 10. Class Weight 消融

| 項目 | 內容 |
|------|------|
| **檔案** | `10_ClassWeight_Ablation.ipynb` |
| **目的** | 驗證類別權重平衡對不平衡資料的影響 |
| **方法** | 比較 class_weight=None vs 'balanced' |
| **假說** | H5：balanced 能提升少數類別的 Sensitivity |

**結論**：

| 設定 | AUC | Sensitivity |
|------|-----|-------------|
| None | ~相同 | 0.30 |
| balanced | ~相同 | **0.65** |

**關鍵發現**：balanced 大幅提升 Sensitivity，AUC 幾乎不變。對不平衡資料必要。

---

### 21. Delta 特徵消融 ⭐

| 項目 | 內容 |
|------|------|
| **檔案** | `21_Delta_Ablation.ipynb` |
| **目的** | 驗證變化量特徵（Δ）的價值 |
| **方法** | 比較 Y-1 only vs Y-1+Delta |
| **假說** | H2：Delta 特徵能提升預測效能 |

**結論**：

| 特徵集 | HTN | HG | DL |
|--------|-----|----|----|
| Y-1 only | 0.684 | 0.902 | 0.808 |
| Y-1 + Delta | 0.733 | 0.922 | 0.845 |
| **Δ 貢獻** | **+7.2%** | **+2.2%** | **+4.6%** |

**關鍵發現**：
- Delta 對所有疾病都有貢獻
- 高血壓貢獻最大（+7.2%）
- 正確比較是 Y-1+Δ vs Y-1（不是 Full vs w/o Δ）

---

## 資料準備

### 01. 探索性資料分析 (EDA)

| 項目 | 內容 |
|------|------|
| **檔案** | `01_ExploratoryDataAnalysis_Chinese_Dataset.ipynb` |
| **目的** | 了解資料分佈、缺失值、異常值 |
| **產出** | 資料品質報告、特徵分佈圖 |

---

### 02. 資料前處理

| 項目 | 內容 |
|------|------|
| **檔案** | `02_DataPreprocessing.ipynb` |
| **目的** | 資料清洗、特徵工程、格式轉換 |
| **產出** | 滑動窗口格式資料 (`SUA_sliding_window.csv`) |

---

## 進階實驗（探索性）

### 12-18. PySR 符號回歸系列

| 檔案 | 目的 |
|------|------|
| `12_PySR_Experiment.ipynb` | 初步 PySR 實驗 |
| `15_PySR_Depth_Experiment.ipynb` | 公式深度實驗 |
| `16_PySR_Parameter_Tuning.ipynb` | 參數調整 |
| `18_PySR_Complex_Formulas.ipynb` | 複雜公式探索 |

**目的**：找出可解釋的數學公式（如 `風險 = 0.3×BMI + 0.2×Age`）

**狀態**：需要用滑動窗口資料重做

**初步發現**：
- 高血壓：SBP 是主要因子
- 高血糖：FBG 是主要因子
- 高血脂：TC 是主要因子

---

### 14. 健檢次數實驗 ⭐

| 項目 | 內容 |
|------|------|
| **檔案** | `14_Checkup_Frequency_Experiment.ipynb` |
| **目的** | 驗證健檢次數與預測準確度的關係 |
| **方法** | 固定預測 T5，改變輸入健檢次數（1~4 次） |
| **資料** | 2,526 人（皆有 5 次以上健檢） |
| **假說** | H1：健檢次數越多，預測越準 |

**結論**：

| 健檢次數 | HTN | HG | DL | 平均 AUC |
|----------|-----|----|----|---------|
| 1 次（T4→T5） | 0.666 | 0.931 | 0.867 | 0.821 |
| 2 次（T3,T4→T5） | 0.679 | 0.940 | 0.879 | 0.832 |
| 3 次（T2~T4→T5） | 0.676 | 0.942 | 0.883 | 0.834 |
| 4 次（T1~T4→T5） | **0.835** | **0.945** | 0.882 | **0.887** |

**關鍵發現**：
- ✅ 假說成立：健檢次數越多，預測越準（平均 AUC 0.821 → 0.887）
- 🔍 **意外發現**：只看 1 次健檢已有很高 AUC（HG=0.931, DL=0.867）
- 高血壓受益最大：4 次 vs 1 次提升 **+0.170**
- 高血糖/高血脂邊際效益遞減：僅提升 +0.014 / +0.015

---

## 已歸檔實驗

以下實驗使用舊資料格式，已被新版 notebook 取代：

| 舊版 | 取代者 | 說明 |
|------|--------|------|
| 03_ModelBuilding | 17_SlidingWindow | 模型比較 |
| 04_XGBoost | 17_SlidingWindow | XGBoost 實驗 |
| 05_NeuralNetworks | 20_MTL_vs_STL | 神經網路 |
| 06_SVM | 17_SlidingWindow | SVM 實驗 |
| 07_GeneticProgramming | 12-18_PySR | 符號回歸 |
| 08_SHAP_Analysis | 19_SHAP_SlidingWindow | SHAP 分析 |
| 09_Delta_Ablation | 21_Delta_Ablation | Delta 消融 |

---

## 假說驗證總結

| 假說 | 內容 | 實驗 | 結果 |
|------|------|------|------|
| **H1** | 健檢次數越多越準 | 14 | ✅ **確認**（但 1 次已很準） |
| **H2** | Delta 特徵有價值 | 21 | ✅ **確認**（+2~7%） |
| **H3** | MTL 優於 STL | 20 | ❌ **否定**（無顯著差異） |
| **H4** | LR 效能接近黑盒 | 17 | ✅ **確認**（2/3 疾病最佳） |
| **H5** | balanced 提升 Sensitivity | 10 | ✅ **確認**（+35%） |
| **H6** | PySR 找到有意義公式 | 12-18 | ⏳ 待完成 |

---

## 論文對應

| 論文章節 | 對應實驗 |
|----------|---------|
| **Method - Data** | 01, 02 |
| **Method - Models** | 17 |
| **Results - Performance** | 17 |
| **Results - Interpretability** | 19 (SHAP) |
| **Results - MTL** | 20 |
| **Results - Ablation** | 10, 21 |
| **Discussion** | 所有實驗的綜合討論 |

---

## 相關文件

- [假說列表](../07_plans/hypothesis_list.md)
- [MTL 完整分析](summaries/MTL_vs_STL_完整分析.md)
- [Delta 消融分析](summaries/Delta_Ablation_完整分析.md)
- [共病分析](summaries/Comorbidity_Analysis.md)
