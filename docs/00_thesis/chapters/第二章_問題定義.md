# 2.8 問題定義 (Problem Formulation)

> **建立日期**：2026-01-12
> **最後更新**：2026-01-12
> **狀態**：草稿
> **位置**：第二章末，承接文獻探討、引出研究方法

---

## 資料表示 (Data Representation)

### 滑動窗口設計 (Sliding Window Approach)

本研究採用滑動窗口方法處理縱向健檢資料，參考 Wang et al. (2024) 之設計。每位患者若有 n 次健檢記錄，可生成 (n-2) 個訓練樣本：

```text
患者健檢序列: T1 → T2 → T3 → T4 → T5
                 ↓
Window 1: (T1, T2) → T3
Window 2: (T2, T3) → T4
Window 3: (T3, T4) → T5
```

此設計的優點：

1. **樣本擴增**：6,056 位患者可生成 13,514 個訓練樣本（約 2.2 倍）
2. **資料一致性**：每個窗口的時間間隔相同（約 2 年）
3. **充分利用縱向資訊**：患者的長期健康趨勢被完整捕捉

### 特徵向量定義

對於第 j 個滑動窗口樣本，其輸入特徵向量定義為：

$$\mathbf{x}_j = [\mathbf{x}_j^{(input1)}, \mathbf{x}_j^{(input2)}, \boldsymbol{\delta}_j] \in \mathbb{R}^{26}$$

其中：

- $\mathbf{x}_j^{(input1)} \in \mathbb{R}^{10}$：窗口第一時間點的生理指標
- $\mathbf{x}_j^{(input2)} \in \mathbb{R}^{10}$：窗口第二時間點的生理指標
- $\boldsymbol{\delta}_j = \mathbf{x}_j^{(input2)} - \mathbf{x}_j^{(input1)} \in \mathbb{R}^{6}$：變化量特徵（Delta Features）

**重要**：交叉驗證時採用 GroupKFold，確保同一患者的所有窗口樣本皆在同一 fold，避免資料洩漏。

---

## 特徵定義 (Feature Definition)

### 基線與追蹤特徵（共 20 維）

| 類別 | 特徵 | T1 | T2 |
|------|------|----|----|
| 人口統計 | 年齡 (Age) | age_T1 | age_T2 |
| | 性別 (Gender) | gender | - |
| 生理測量 | 收縮壓 (SBP) | SBP_T1 | SBP_T2 |
| | 舒張壓 (DBP) | DBP_T1 | DBP_T2 |
| | BMI | BMI_T1 | BMI_T2 |
| 血液檢驗 | 空腹血糖 (FBG) | FBG_T1 | FBG_T2 |
| | 總膽固醇 (TC) | TC_T1 | TC_T2 |
| | 三酸甘油酯 (TG) | TG_T1 | TG_T2 |
| | 高密度脂蛋白 (HDL) | HDL_T1 | HDL_T2 |
| | 血尿酸 (SUA) | SUA_T1 | SUA_T2 |

### 變化量特徵（共 6 維）

變化量特徵捕捉兩次健檢之間的動態變化：

$$\delta_j = x_j^{(T2)} - x_j^{(T1)}, \quad j \in \{SBP, DBP, FBG, TC, TG, SUA\}$$

| 特徵 | 定義 | 臨床意義 |
|------|------|----------|
| delta_SBP | SBP_T2 - SBP_T1 | 血壓上升趨勢 |
| delta_DBP | DBP_T2 - DBP_T1 | 血壓上升趨勢 |
| delta_FBG | FBG_T2 - FBG_T1 | 血糖惡化趨勢 |
| delta_TC | TC_T2 - TC_T1 | 膽固醇惡化趨勢 |
| delta_TG | TG_T2 - TG_T1 | 血脂惡化趨勢 |
| delta_SUA | SUA_T2 - SUA_T1 | 尿酸上升趨勢 |

---

## 預測任務 (Prediction Tasks)

定義三個二元分類任務 **T = {T_HTN, T_HG, T_DL}**：

| 任務 | 符號 | 預測目標 | 診斷標準 |
|------|------|----------|----------|
| 高血壓 | T_HTN | hypertension_T3 | SBP ≥ 140 或 DBP ≥ 90 mmHg |
| 高血糖 | T_HG | hyperglycemia_T3 | FBG ≥ 7.0 mmol/L |
| 高血脂 | T_DL | dyslipidemia_T3 | TC ≥ 6.2 或 TG ≥ 2.3 mmol/L |

對於任務 k，預測目標為：

$$y_i^{(k)} \in \{0, 1\}, \quad k \in \{HTN, HG, DL\}$$

其中 0 表示未發病，1 表示發病。

---

## 學習框架 (Learning Framework)

### Single-Task Learning (STL)

對每個任務 k，獨立學習映射函數：

$$f_k: \mathbb{R}^{26} \rightarrow [0,1]$$

訓練三個獨立模型，各自優化對應任務的損失函數。

### Multi-Task Learning (MTL)

學習共享映射函數：

$$f: \mathbb{R}^{26} \rightarrow [0,1]^3$$

單一模型同時輸出三個任務的預測機率，透過共享表示學習任務間的關聯性。

---

## 優化目標 (Optimization Objective)

最小化加權二元交叉熵損失：

$$\mathcal{L} = \sum_{k \in \{HTN, HG, DL\}} \sum_{i=1}^{N} w_k^{(y_i^{(k)})} \cdot \text{BCE}(y_i^{(k)}, \hat{y}_i^{(k)})$$

其中：
- $w_k^{(y)}$ 為任務 k 中類別 y 的權重，用於處理類別不平衡
- $\text{BCE}(y, \hat{y}) = -[y \log(\hat{y}) + (1-y) \log(1-\hat{y})]$

### 類別權重設定

由於資料存在嚴重類別不平衡（正例比例 5%-15%），採用 `class_weight='balanced'`：

$$w^{(y)} = \frac{N}{2 \times N_y}$$

其中 $N_y$ 為類別 y 的樣本數。

---

## 評估指標 (Evaluation Metrics)

| 指標 | 定義 | 說明 |
|------|------|------|
| **AUC-ROC** | ROC 曲線下面積 | 主要評估指標，衡量區分能力 |
| Sensitivity | TP / (TP + FN) | 正確識別患病者的比例 |
| Specificity | TN / (TN + FP) | 正確識別健康者的比例 |
| F1-Score | 2 × (Precision × Recall) / (Precision + Recall) | 精確率與召回率的調和平均 |

---

## 問題摘要

| 項目 | 內容 |
|------|------|
| **輸入** | 26 維特徵向量（Tinput1 + Tinput2 + Delta） |
| **輸出** | 三個二元分類結果 |
| **資料設計** | 滑動窗口：6,056 患者 → 13,514 樣本 |
| **預測時程** | (Ti, Ti+1) → Ti+2，約 2 年預測窗口 |
| **學習框架** | STL（獨立模型）與 MTL（共享模型）比較 |
| **交叉驗證** | StratifiedGroupKFold（避免資料洩漏） |
| **核心創新** | Delta 特徵 + 滑動窗口樣本擴增 |

---

## 相關文件

- [第三章_研究方法.md](第三章_研究方法.md)
- [論文章節規劃.md](../../archive/論文章節規劃.md)
- [SUA_Dataset_Documentation.md](../../06_datasets/SUA_Dataset_Documentation.md)
