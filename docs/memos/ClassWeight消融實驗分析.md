# Class Weight 消融實驗分析

> **建立日期**：2025-12-16
> **實驗 Notebook**：`10_ClassWeight_Ablation.ipynb`
> **狀態**：已完成

---

## 1. 實驗目的

驗證 **class_weight（類別權重）** 對不平衡資料集預測效能的影響：

1. **class_weight 是否能提升模型效能？**
2. **不同權重設定的 Sensitivity-Specificity Trade-off**
3. **針對不同應用場景的最佳權重建議**

---

## 2. 實驗設計

### 2.1 類別不平衡情況

| 疾病 | 患病率 | 負:正比例 |
|------|--------|-----------|
| 高血壓 | 16.68% | 5.0:1 |
| 高血糖 | 5.53% | 17.1:1 |
| 高血脂 | 5.96% | 15.8:1 |

### 2.2 測試的權重設定

| 設定 | 說明 |
|------|------|
| **None** | 無權重（原始分佈）|
| **balanced** | 自動計算平衡權重 |
| **1:3** | 正類權重為負類的 3 倍 |
| **1:5** | 正類權重為負類的 5 倍 |
| **1:10** | 正類權重為負類的 10 倍 |

### 2.3 評估指標

- **AUC**：整體判別能力（與閾值無關）
- **Sensitivity（召回率）**：找出患病者的能力
- **Specificity**：正確排除健康者的能力
- **F1-Score**：精確率與召回率的調和平均
- **Balanced Accuracy**：平衡準確率

---

## 3. 實驗結果

### 3.1 Logistic Regression 結果

#### 高血壓

| 權重設定 | AUC | Sensitivity | Specificity | F1 | Balanced_Acc |
|----------|-----|-------------|-------------|-----|--------------|
| None | 0.754 | 0.053 | 0.989 | 0.096 | 0.521 |
| balanced | 0.754 | 0.744 | 0.648 | 0.425 | 0.696 |
| 1:3 | 0.754 | 0.513 | 0.803 | 0.411 | 0.658 |
| 1:5 | 0.754 | 0.744 | 0.648 | 0.425 | 0.696 |
| **1:10** | 0.754 | **0.903** | 0.443 | 0.385 | 0.673 |

#### 高血糖

| 權重設定 | AUC | Sensitivity | Specificity | F1 | Balanced_Acc |
|----------|-----|-------------|-------------|-----|--------------|
| None | 0.933 | 0.367 | 0.991 | 0.482 | 0.679 |
| **balanced** | 0.932 | **0.854** | 0.883 | 0.443 | **0.868** |
| 1:3 | 0.934 | 0.579 | 0.970 | 0.553 | 0.774 |
| 1:5 | 0.934 | 0.690 | 0.955 | 0.559 | 0.822 |
| 1:10 | 0.933 | 0.764 | 0.921 | 0.490 | 0.842 |

#### 高血脂

| 權重設定 | AUC | Sensitivity | Specificity | F1 | Balanced_Acc |
|----------|-----|-------------|-------------|-----|--------------|
| None | 0.867 | 0.094 | 0.994 | 0.153 | 0.544 |
| **balanced** | 0.867 | **0.806** | 0.773 | 0.299 | **0.789** |
| 1:3 | 0.868 | 0.349 | 0.962 | 0.357 | 0.655 |
| 1:5 | 0.868 | 0.515 | 0.921 | 0.373 | 0.718 |
| 1:10 | 0.867 | 0.693 | 0.839 | 0.326 | 0.766 |

---

### 3.2 XGBoost 結果

#### 高血壓

| 權重設定 | AUC | Sensitivity | Specificity | F1 | Balanced_Acc |
|----------|-----|-------------|-------------|-----|--------------|
| **None** | **0.791** | 0.170 | 0.963 | 0.251 | 0.567 |
| balanced | 0.789 | 0.632 | 0.781 | 0.463 | 0.706 |
| 1:3 | 0.787 | 0.480 | 0.849 | 0.430 | 0.664 |
| 1:5 | 0.787 | 0.623 | 0.781 | 0.458 | 0.702 |
| 1:10 | 0.781 | **0.752** | 0.693 | 0.458 | **0.723** |

#### 高血糖

| 權重設定 | AUC | Sensitivity | Specificity | F1 | Balanced_Acc |
|----------|-----|-------------|-------------|-----|--------------|
| **None** | **0.927** | 0.385 | 0.986 | 0.475 | 0.686 |
| balanced | 0.918 | **0.600** | 0.956 | 0.511 | **0.778** |
| 1:3 | 0.923 | 0.499 | 0.977 | 0.526 | 0.738 |
| 1:5 | 0.920 | 0.525 | 0.973 | 0.527 | 0.749 |
| 1:10 | 0.918 | 0.582 | 0.963 | 0.525 | 0.772 |

#### 高血脂

| 權重設定 | AUC | Sensitivity | Specificity | F1 | Balanced_Acc |
|----------|-----|-------------|-------------|-----|--------------|
| **None** | **0.870** | 0.138 | 0.994 | 0.223 | 0.566 |
| balanced | 0.857 | **0.488** | 0.926 | 0.367 | **0.707** |
| 1:3 | 0.868 | 0.244 | 0.981 | 0.313 | 0.612 |
| 1:5 | 0.866 | 0.324 | 0.968 | 0.353 | 0.646 |
| 1:10 | 0.863 | 0.404 | 0.945 | 0.355 | 0.674 |

---

### 3.3 balanced vs None 比較

| 疾病 | 模型 | AUC 變化 | Sensitivity 變化 | Specificity 變化 |
|------|------|----------|------------------|------------------|
| 高血壓 | LR | -0.000 | **+0.690** | -0.341 |
| 高血壓 | XGB | -0.002 | **+0.461** | -0.182 |
| 高血糖 | LR | -0.001 | **+0.487** | -0.108 |
| 高血糖 | XGB | -0.010 | **+0.215** | -0.030 |
| 高血脂 | LR | +0.000 | **+0.712** | -0.221 |
| 高血脂 | XGB | -0.012 | **+0.349** | -0.068 |

**關鍵發現**：
- **AUC 幾乎不變**（<1% 變化）
- **Sensitivity 大幅提升**（+21%~71%）
- **Specificity 下降**（-3%~34%）

---

## 4. 關鍵發現

### 4.1 AUC 對 class_weight 不敏感

| 疾病 | AUC 變化範圍 |
|------|--------------|
| 高血壓 | 0.754~0.791（幾乎不變）|
| 高血糖 | 0.918~0.934（<2%）|
| 高血脂 | 0.857~0.870（<2%）|

**原因**：AUC 衡量的是模型的排序能力，與分類閾值無關。class_weight 主要影響閾值的選擇。

### 4.2 Sensitivity vs Specificity Trade-off

```
權重增加 → Sensitivity ↑ + Specificity ↓
         → 更多真陽性 + 更多假陽性
         → 適合篩檢（寧可錯殺，不可放過）
```

### 4.3 不同不平衡程度的影響

| 疾病 | 不平衡程度 | class_weight 效果 |
|------|------------|-------------------|
| 高血壓 | 5:1（輕度）| 效果較小 |
| 高血糖 | 17:1（重度）| 效果明顯 |
| 高血脂 | 16:1（重度）| 效果明顯 |

---

## 5. 最佳權重設定推薦

### 5.1 以 AUC 為主要指標

| 疾病 | 推薦設定 | AUC |
|------|----------|-----|
| 高血壓 | XGB + None | 0.791 |
| 高血糖 | LR + 1:3 | 0.934 |
| 高血脂 | XGB + None | 0.870 |

### 5.2 以 Sensitivity 為主要指標（疾病篩檢）

| 疾病 | 推薦設定 | Sensitivity | AUC |
|------|----------|-------------|-----|
| 高血壓 | LR + 1:10 | 0.903 | 0.754 |
| 高血糖 | LR + balanced | 0.854 | 0.932 |
| 高血脂 | LR + balanced | 0.806 | 0.867 |

### 5.3 以 Balanced Accuracy 為主要指標

| 疾病 | 推薦設定 | Balanced_Acc |
|------|----------|--------------|
| 高血壓 | XGB + 1:10 | 0.723 |
| 高血糖 | LR + balanced | 0.868 |
| 高血脂 | LR + balanced | 0.789 |

---

## 6. 應用場景建議

| 場景 | 目標 | 建議權重 | 說明 |
|------|------|----------|------|
| **大規模篩檢** | 高 Sensitivity | balanced 或 1:5~1:10 | 寧可多檢查，不漏掉患者 |
| **確診輔助** | 高 Specificity | None | 減少不必要的進一步檢查 |
| **一般應用** | 平衡 | balanced | 兼顧兩者 |
| **成本敏感** | 視成本比 | 自訂權重 | 根據 FP/FN 成本調整 |

---

## 7. 結論

1. **class_weight 對 AUC 影響很小**
   - AUC 主要反映模型的排序能力，與閾值無關
   - 不應用 AUC 來評估 class_weight 的效果

2. **class_weight 主要影響 Sensitivity-Specificity 平衡**
   - 增加正類權重 → Sensitivity ↑, Specificity ↓
   - balanced 提供合理的平衡點

3. **不平衡程度越高，class_weight 效果越明顯**
   - 高血壓（5:1）：效果較小
   - 高血糖/高血脂（>15:1）：效果明顯

4. **建議預設使用 balanced**
   - 對大多數應用場景是合理的選擇
   - 需要極高 Sensitivity 時可考慮 1:5 或 1:10

---

## 8. 產出檔案

### 圖片（`docs/experiments/`）

| 檔案 | 說明 |
|------|------|
| `class_weight_auc_sensitivity.png` | AUC vs Sensitivity 散點圖 |
| `class_weight_sens_spec_tradeoff.png` | Sensitivity vs Specificity Trade-off |

### 數據（`results/`）

| 檔案 | 說明 |
|------|------|
| `class_weight_ablation_results.csv` | 完整實驗結果 |
| `10_ClassWeight_Ablation_output.txt` | Notebook 執行結果 |

---

**相關文件**：
- [10_ClassWeight_Ablation.ipynb](../../notebooks/experiments/10_ClassWeight_Ablation.ipynb)
- [Delta消融實驗分析.md](Delta消融實驗分析.md)
