# SMOTE + SHAP Framework (2025) 論文完整翻譯

**原文標題**: Interpretable Machine Learning Framework for Diabetes Prediction: Integrating SMOTE Balancing with SHAP Explainability for Clinical Decision Support

**期刊**: Healthcare (MDPI), 2025年10月
**作者**: Pathamakorn Netayawijit, Wirapong Chansanam, Kanda Sorn-In
**機構**: Khon Kaen University, Thailand
**DOI**: https://doi.org/10.3390/healthcare13202588

---

## 摘要 (Abstract)

**背景**：類別不平衡和有限的可解釋性仍然是機器學習在糖尿病預測臨床應用的主要障礙。這些挑戰往往導致對高風險病例的敏感度不佳，以及對基於AI的決策支援系統的信任度降低。本研究通過整合基於SMOTE的重採樣和SHAP驅動的可解釋性來解決這些限制，旨在增強預測效能和臨床透明度，以實現真實世界部署。

**目標**：開發和驗證一個可解釋的機器學習框架，通過先進的重採樣技術解決類別不平衡問題，同時提供臨床上有意義的解釋以增強決策支援。本研究作為方法學上嚴謹的概念驗證，優先考慮分析完整性而非規模。雖然基於1500筆記錄的計算可行子集，未來工作將擴展到完整的100,000名患者資料集，以評估可擴展性和外部效度。

**方法**：我們實施了一個強健的七階段管道，整合合成少數類過採樣技術（SMOTE）與SHapley加法解釋（SHAP），以增強模型可解釋性並解決類別不平衡。五種機器學習演算法——隨機森林、梯度提升、支援向量機（SVM）、邏輯回歸和XGBoost——在從Kaggle公開的糖尿病預測資料集（n = 100,000）中分層隨機抽取的1500筆患者記錄上進行比較評估。為確保方法學嚴謹性並防止資料洩漏，所有預處理步驟——包括SMOTE應用——都在5折分層交叉驗證框架的訓練折內執行。

**結果**：Random Forest-SMOTE模型達到優越效能：
- 準確率：96.91%（95% CI: 95.4–98.2%）
- AUC：0.998
- 敏感度：99.5%
- 特異度：97.3%

SHAP分析識別出glucose（SHAP值：2.34）和BMI（SHAP值：1.87）為主要預測因子，展示強烈的臨床一致性。特徵交互分析揭示glucose和BMI之間的協同效應，為個人化介入策略提供可行的見解。

**結論**：儘管結果promising，在任何臨床部署之前，需要對所提出的框架進行進一步驗證。在這個階段，該研究應被視為方法學概念驗證，而非臨床可推廣的評估。

**關鍵詞**：diabetes prediction, machine learning, SMOTE, SHAP, explainable AI, Random Forest, clinical decision support

---

## 1. 引言 (Introduction)

糖尿病仍然是全球公共衛生的重大挑戰，影響超過5.37億人，預計到2045年將增至7.83億人。這種日益增長的盛行率對醫療保健系統造成重大負擔，強調了早期檢測和風險分層工具的需求，以實現及時干預。

### 臨床層面的挑戰

第2型糖尿病（T2DM）由於其複雜的病因學而特別具有問題性，由遺傳傾向、生活方式行為和環境影響的多因素相互作用驅動。傳統診斷指標如：
- 空腹血漿葡萄糖（FPG）
- 口服葡萄糖耐量試驗（OGTT）
- 糖化血紅蛋白（HbA1c）

這些提供有價值的臨床基準，但在捕捉與疾病發病相關的細微、多維風險途徑方面能力有限。

### 研究缺口

考慮到臨床轉化和資料代表性的挑戰，三個主要問題主導當前研究領域：

1. **類別不平衡**：真實世界醫療資料集固有地不平衡，非糖尿病病例大大超過糖尿病病例。這種偏斜導致模型在整體準確率高的同時，未能識別少數類別病例——這是疾病篩檢中的關鍵缺陷。

2. **缺乏可解釋性**：高效能模型的「黑箱」特性破壞了臨床醫生的信任和監管接受度。醫生需要透明、可操作的解釋來證明診斷和治療決策的合理性。

3. **有限的普遍性**：許多模型在小型、局部化的資料集上訓練，缺乏人口統計多樣性，限制了它們在不同人群中的普遍性。

### 1.1 研究目標與假說

本研究旨在通過開發和驗證一個概念驗證的可解釋ML框架來彌合這一轉化差距，主要目標包括：

1. 使用5折分層交叉驗證評估SMOTE對五種ML模型效能的影響
2. 基於準確率、AUC、敏感度、特異度和統計顯著性（McNemar檢定與Bonferroni校正）確定最佳模型
3. 使用SHAP提供全局和局部可解釋性，並對照臨床指南和專家共識進行驗證
4. 評估模型穩定性、跨子群的公平性和EHR整合的計算效率

**假說**：SMOTE和SHAP的整合將產生具有優越預測效能（AUC > 0.99）和臨床有意義解釋的模型。

### 1.2 意義與預期貢獻

本研究對醫療AI領域做出四項關鍵貢獻：

1. **方法學嚴謹性**：僅在訓練折內實施SMOTE，防止資料洩漏
2. **臨床合理性**：SHAP輸出經過內分泌科專家的結構化審查
3. **公平性和普遍性**：按年齡、性別和BMI的子群分析確保演算法公平性
4. **部署準備**：預測延遲0.012 ms，適合即時整合到EHR系統

---

## 2. 相關研究 (Related Works)

### 2.1 糖尿病預測方法的演進

#### 2.1.1 傳統統計方法

早期糖尿病預測依賴傳統統計方法，包括邏輯回歸、判別分析和基本風險評分系統。Framingham風險評分等工具提供了基礎框架，但受線性假設和無法捕捉複雜特徵交互的限制。

#### 2.1.2 機器學習範式轉變

機器學習技術的引入標誌著糖尿病預測能力的範式轉變。集成方法如Random Forest和Gradient Boosting始終展示出優於傳統統計方法的效能。

### 2.2 醫療資料中的類別不平衡處理

#### 2.2.1 重採樣技術

醫療資料集中類別不平衡的挑戰在多個領域得到廣泛研究。過採樣技術，特別是SMOTE及其變體，在改善少數類別檢測的同時保持整體模型效能方面顯示出前景。

#### 2.2.2 先進的合成資料生成

最近在合成資料生成方面的發展引入了傳統過採樣技術的複雜變體。Akshaya等人研究了基於集成的SMOTE方法，報告95.8%準確率和0.983 AUC。

### 2.3 醫療應用中的可解釋AI

#### 2.3.1 SHAP分析框架

特徵重要性分析和模型可解釋性在醫療應用中獲得前所未有的重要性。SHAP已成為解釋機器學習預測的理論基礎框架，提供全局和局部解釋。

### 2.4 深度學習和先進架構

CNN和RNN在處理複雜醫療資料方面顯示出潛力，但這些方法在模型可解釋性方面面臨重大挑戰。

### 2.6 研究缺口與機會

| 研究 | 類別不平衡處理 | 可解釋性方法 | 資料集大小 | AUC | 準確率 | 臨床驗證 |
|------|--------------|-------------|----------|-----|-------|---------|
| Abnoosian et al. | None | None | 15,000 | 0.962 | 94.20% | ✗ |
| Chowdhury et al. | Ensemble SMOTE | None | 8,500 | 0.983 | 95.80% | ✗ |
| Akshaya et al. | None | LIME | ~1,200 | 0.950 | ~92% | ✗ |
| Akhtar et al. | SMOTE | XAI (LIME) | ~1,000 | 0.880 | ~88% | ✗ |
| **本研究** | **SMOTE + 洩漏防護** | **SHAP (Global + Local)** | **1,500** | **0.998** | **96.91%** | **✓** |

---

## 3. 方法論 (Methodology)

### 3.1 概述與研究設計

本研究採用回顧性橫斷面設計，使用來自Kaggle的公開資料集「Diabetes Prediction Dataset」。該資料集包含來自多個醫療提供者的100,000筆去識別化患者記錄。

為了計算效率和聚焦分析，隨機抽取了1500名患者的代表性子集，同時保留原始類別分佈（約34.9%糖尿病病例）。

**樣本特徵**：
- 年齡：21-75歲
- 性別分佈：48%男性，52%女性
- 糖尿病：524人（34.9%）
- 非糖尿病：976人（65.1%）

### 3.2 方法論工作流程

```
1. 原始資料集 (n = 1,500)
      ↓
2. 資料預處理管道
   - 缺失值填補
   - 離群值檢測與處理
   - 特徵縮放（Z-score標準化）
      ↓
3. 訓練-測試分割 (80/20)
   - SMOTE（僅在訓練折內）
   - Grid Search + 交叉驗證
      ↓
4. 模型訓練與優化
   - SMOTE
   - Grid Search + 交叉驗證
      ↓
5. 模型評估
   - 效能指標（Accuracy, F1-score）
   - k-Fold 交叉驗證
   - 統計顯著性檢定
```

### 3.3 資料預處理管道

#### 3.3.1 缺失值處理策略

| 缺失比例 | 處理方法 | 適用特徵 |
|---------|---------|---------|
| <5% | 中位數填補 | Glucose, BP, BMI |
| 5-10% | MICE（鏈式方程多重填補） | Skin Thickness |
| >10% | 多重填補 | Insulin |

#### 3.3.2 離群值檢測與處理

使用多階段離群值檢測協議：
- **IQR方法**：定義離群值為低於Q1 − 1.5 × IQR或高於Q3 + 1.5 × IQR的值
- **Z-score方法**：|z| > 3視為潛在離群值
- **臨床合理性審查**：由內分泌科醫師評估
- **Winsorization**：在5th/95th百分位數進行

#### 3.3.3 特徵標準化

所有連續變數使用Z-score標準化：

$$z = \frac{x - \mu}{\sigma}$$

### 3.4 SMOTE實施

#### 3.4.1 SMOTE配置

| 參數 | 值 | 理由 |
|-----|---|-----|
| k-neighbors | 5 | 通過grid search優化 |
| Sampling strategy | 1:1 ratio | 平衡類別分佈 |
| Random state | 42 | 可重現性 |

#### 3.4.2 資料洩漏防護協議

1. 資料集在任何SMOTE應用之前分為訓練（80%）和測試（20%）集
2. SMOTE僅應用於每個交叉驗證折的訓練集
3. 模型評估在原始、未修改的測試集上進行
4. SMOTE在5折交叉驗證的每一折中獨立重新應用

**SMOTE插值公式**：
$$x_{new} = x^i + \lambda \times (x_i' - x_i)$$

其中 $x_i$ 是少數類別實例，$x_i'$ 是其k近鄰之一，$\lambda \in [0, 1]$ 是隨機標量。

### 3.5 機器學習演算法

選擇的五種ML演算法：
- Random Forest
- Gradient Boosting
- Support Vector Machine (SVM)
- Logistic Regression
- XGBoost

#### 3.5.2 超參數優化

使用grid search與5折分層交叉驗證進行超參數優化。

**Random Forest搜索空間**：
- n_estimators：100, 150, 200, 250
- max_depth：10, 12, 15, 18
- min_samples_split：5, 10, 20

**最佳配置**：n_estimators = 200, max_depth = 15, min_samples_split = 10

### 3.6 評估框架

#### 3.6.1 效能指標

| 指標 | 公式 | 臨床重要性 | 臨床可接受閾值 |
|-----|------|----------|--------------|
| Accuracy | (TP+TN)/(TP+TN+FP+FN) | 整體診斷正確性 | ≥85% |
| Precision (PPV) | TP/(TP+FP) | 最小化假警報 | ≥80% |
| Recall (Sensitivity) | TP/(TP+FN) | 檢測所有糖尿病病例 | ≥90% |
| Specificity | TN/(TN+FP) | 正確識別健康個體 | ≥85% |
| F1-Score | 2×(Prec×Rec)/(Prec+Rec) | 平衡效能 | ≥0.80 |
| AUC-ROC | ROC曲線下面積 | 閾值無關的判別能力 | ≥0.85 |
| NPV | TN/(TN+FN) | 陰性結果的可信度 | ≥95% |

### 3.7 可解釋性框架

使用SHAP（SHapley Additive exPlanations）框架：
- 使用TreeExplainer演算法
- 100個代表性訓練樣本的背景資料集
- 產生全局特徵重要性和局部解釋

**SHAP公理驗證**：
- **效率性**：SHAP值總和等於模型預測與預期基線之差
- **對稱性**：具有相同貢獻的特徵獲得相等的SHAP值
- **虛擬性**：不相關特徵被分配零SHAP值
- **可加性**：特徵貢獻在實例之間是可加的

**臨床驗證過程**：
1. 排名特徵重要性與臨床指南比較
2. 三位認證內分泌科醫師獨立審查
3. 跨高效能模型的特徵重要性一致性評估
4. 交互效應（如glucose × BMI）與已知病理生理機制的對齊檢查

---

## 4. 結果 (Results)

### 4.1 資料集特徵與描述性統計

最終資料集包含1500名參與者：
- 糖尿病：524人（34.9%）
- 非糖尿病：976人（65.1%）
- 平均年齡：33.2 ± 11.8歲
- 糖尿病組年齡顯著較高（35.1 ± 12.4 vs. 31.2 ± 11.1歲，p < 0.001）
- 糖尿病組glucose顯著較高（142.8 ± 31.2 vs. 108.5 ± 26.7 mg/dL，Cohen's d = 1.23）
- 糖尿病組BMI顯著較高（35.2 ± 7.8 vs. 29.9 ± 7.9 kg/m²，d = 0.67）

### 4.2 模型效能比較

| 演算法 | 資料集 | Accuracy (%) | AUC | F1-Score | Recall | Precision |
|-------|-------|-------------|-----|----------|--------|-----------|
| **Random Forest** | Original | **96.91** | **0.998** | 0.970 | 0.990 | 0.950 |
| **Random Forest** | SMOTE | **96.67** | **0.997** | 0.970 | 0.960 | 0.970 |
| Gradient Boosting | Original | 95.70 | 0.993 | 0.950 | 0.960 | 0.940 |
| Gradient Boosting | SMOTE | 93.50 | 0.991 | 0.930 | 0.940 | 0.920 |
| SVM | Original | 83.00 | 0.840 | 0.800 | 0.830 | 0.780 |
| SVM | SMOTE | 79.30 | 0.860 | 0.800 | 0.820 | 0.780 |

**關鍵發現**：
- Random Forest在兩種資料分佈下都展示出優越的穩健性
- Gradient Boosting在SMOTE後準確率下降（95.7% → 93.5%）
- SVM表現最差，SMOTE後準確率從83%降至79.3%

### 4.3 與最先進方法的比較

| 研究 | 年份 | 方法 | Accuracy (%) | AUC | 關鍵創新 |
|-----|-----|-----|-------------|-----|---------|
| **本研究** | 2024 | RF + SMOTE + SHAP | **96.91** | **0.998** | 平衡集成 + 可解釋性 |
| Abnoosian et al. | 2024 | XGBoost + Mahalanobis | 94.20 | 0.962 | 離群值移除 |
| Kumar et al. | 2024 | Ensemble SMOTE | 95.80 | 0.983 | 多分類器 |
| Akhtar et al. | 2025 | ML + XAI | ~88.00 | 0.900 | 透明預測 |
| Akshaya et al. | 2025 | Hybrid Ensemble | ~92.00 | 0.950 | 非侵入性EGG |

### 4.4 診斷效能指標

| 指標 | 值 | 臨床解釋 |
|-----|---|---------|
| **Sensitivity** | **99.50%** | 優異的病例檢測 |
| **Specificity** | **97.30%** | 最小假警報 |
| **PPV** | **96.20%** | 陽性預測高可信度 |
| **NPV** | **99.70%** | 強大的排除能力 |
| **False Negative Rate** | **0.50%** | 近乎零的遺漏病例 |

### 4.5 可解釋性與特徵重要性

**SHAP分析結果**：

| 排名 | 特徵 | SHAP值 | 臨床意義 |
|-----|-----|--------|---------|
| 1 | **Glucose** | **2.34 ± 0.67** | 主要診斷指標 |
| 2 | **BMI** | **1.87 ± 0.43** | 肥胖風險因子 |
| 3 | Age | 1.23 ± 0.31 | 人口統計風險 |
| 4 | Diabetes Pedigree Function | 0.89 ± 0.24 | 家族史 |
| 5 | Blood Pressure, Insulin | (較低) | - |

**交互效應**：Glucose × BMI interaction = 0.45（協同效應）

### 4.6 模型穩定性與交叉驗證

| Fold | Accuracy (%) | AUC | 評估 |
|------|-------------|-----|-----|
| 1 | 96.80 | 0.997 | Excellent |
| 2 | 97.10 | 0.999 | Outstanding |
| 3 | 96.50 | 0.998 | Excellent |
| 4 | 97.30 | 0.998 | Outstanding |
| 5 | 96.90 | 0.998 | Excellent |
| **Mean ± SD** | **96.90 ± 0.30** | **0.998 ± 0.001** | **Highly Stable** |

**變異係數（CV）**：0.31%，表示最小變異和強大的泛化能力

### 4.7 子群分析與演算法公平性

| 子群 | Accuracy (%) | AUC | 樣本數 |
|-----|-------------|-----|-------|
| **年齡** | | | |
| 21-35歲 | 97.20 | 0.998 | 720 |
| 36-50歲 | 96.80 | 0.997 | 486 |
| 51+歲 | 96.40 | 0.996 | 294 |
| **性別** | | | |
| 女性 | 97.10 | 0.998 | 980 |
| 男性 | 96.60 | 0.997 | 520 |
| **BMI** | | | |
| 正常 | 95.80 | 0.994 | 312 |
| 過重 | 96.90 | 0.997 | 543 |
| 肥胖 | 97.40 | 0.998 | 645 |

**公平性分析**：
- 年齡差異無顯著性（p = 0.147）
- 性別差異無顯著性（p = 0.283）
- 真陽性率（TPR）差異 < 2%
- 假陽性率（FPR）差異 < 1.5%

### 4.8 計算效率

| 演算法 | 訓練時間 (s) | 預測時間 (ms) | 臨床適用性 |
|-------|------------|-------------|----------|
| Logistic Regression | 0.12 ± 0.02 | 0.001 | 高通量 |
| Decision Tree | 0.18 ± 0.03 | 0.003 | 快速部署 |
| **Random Forest** | **2.34 ± 0.21** | **0.012** | **最佳平衡** |
| SVM | 4.67 ± 0.45 | 0.025 | 批次處理 |

---

## 5. 討論 (Discussion)

### 主要發現

本研究證明，整合Random Forest-SMOTE框架與基於SHAP的可解釋性在糖尿病風險評估中達到優越的預測效能：
- 準確率：96.91%
- AUC：0.998

這些發現確認了使用SMOTE平衡類別分佈和通過SHAP確保可解釋性可以共存而不損害模型效能，從而解決了醫療AI中的兩個持續挑戰：資料不平衡和透明度。

### 與先前研究的比較

與先前研究相比：
- Abnoosian et al.：使用XGBoost達到94.2%準確率
- Chowdhury et al.：使用ensemble SMOTE達到95.8%準確率

本模型不僅達到改進的預測準確率，還提供與已建立的糖尿病風險因子（如glucose和BMI）一致的可解釋輸出。

### 限制

1. **資料來源**：研究依賴公開可用的資料集，缺乏真實臨床記錄限制了外部效度
2. **研究設計**：橫斷面設計限制了時間預測
3. **需要驗證**：需要跨多個醫療系統的前瞻性驗證以確認普遍性

### 未來研究方向

1. **縱向建模**：捕捉動態風險軌跡
2. **聯邦學習**：增強隱私保護協作
3. **臨床工作流程研究**：評估提供者接受度和真實世界影響

---

## 6. 結論 (Conclusions)

本研究呈現了一個方法學上嚴謹的概念驗證，用於應用於公開可用Kaggle資料集的可解釋機器學習框架。該方法展示了強大的內部效度和通過基於SHAP解釋的透明預測；然而，在沒有獨立臨床驗證和前瞻性評估的情況下，發現不可推廣。

**成功達成的目標**：

1. ✅ SMOTE有效改善了少數類別檢測，增強對高風險病例的敏感度
2. ✅ Random Forest模型在評估的演算法中達到最高預測效能
3. ✅ SHAP分析提供了與已建立醫學知識一致的臨床合理的全局和局部解釋
4. ✅ 模型穩定性和子群公平性得到確認，支持未來臨床整合的潛力

---

## 與我們研究的關聯

| 面向 | 本論文 | 我們的研究 |
|------|--------|-----------|
| **SMOTE** | 1:1 ratio, k=5, 在CV fold內執行 | 可借鏡防洩漏設計 |
| **SHAP** | Global + Local + Interaction | 已做Global，可加Interaction |
| **CV** | 5-fold stratified | 已完成5-fold CV |
| **模型** | RF, GB, SVM, LR, XGB | LR, RF, XGB, ANN, SVM, PySR |
| **資料** | Kaggle橫斷面 | HRS縱向三次健檢 |
| **特徵** | 靜態特徵 | T1 + T2 + Δ特徵 |
| **最佳AUC** | 0.998 (RF) | 0.932 (LR for Hyperglycemia) |

### 可借鏡之處

1. **SMOTE data leakage防範**：在CV fold內執行SMOTE
2. **SHAP interaction analysis**：探索特徵間的交互作用（如Glucose × BMI）
3. **專家驗證**：SHAP結果由臨床醫師審查
4. **多指標報告**：不只AUC，還有Sensitivity, Specificity, NPV
5. **McNemar's test**：模型比較的統計檢定方法
6. **子群公平性分析**：確保不同年齡、性別、BMI群體的效能一致

### 限制與注意

- 資料來自Kaggle，非真實臨床環境
- 論文強調「methodological proof-of-concept」
- 需外部驗證才能臨床部署
- AUC 0.998過高，可能資料特性造成（我們的AUC在0.75-0.93範圍更實際）

---

## 參考文獻（重要）

1. GBD 2021 Diabetes Collaborators. Global burden of diabetes 1990-2021. Lancet 2023.
2. American Diabetes Association. Standards of Care in Diabetes—2024. Diabetes Care 2024.
3. Lundberg, S.M.; Lee, S.I. A Unified Approach to Interpreting Model Predictions. NeurIPS 2017.
4. Abnoosian et al. Prediction of Diabetes Using Ensemble of ML Models. BMC Bioinform. 2023.
5. Chowdhury et al. ML and Data Augmentation for Diabetes Using BRFSS. Healthc. Anal. 2024.

---

**相關文件**：
- 摘要版：[Paper_SMOTE_SHAP_2025.md](../memos/Paper_SMOTE_SHAP_2025.md)
- Taiwan MTL論文：[Taiwan_MTL_2025.md](Taiwan_MTL_2025.md)
- 假說列表：[hypothesis_list.md](../hypotheses/hypothesis_list.md)