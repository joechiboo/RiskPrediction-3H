# Q1. 預測規格與問題定義

## 📅 回應日期
2025-09-30

## 🎯 研究目標

**預測未來三高發病風險**：基於個案的前兩次健康檢查結果，預測第三次檢查時是否會發展出三高（高血壓、高血糖、高血脂）。

---

## 📊 問題定義 (Problem Definition)

### 問題類型

**多標籤二元分類 (Multi-label Binary Classification)**

預測三種疾病的發病狀態，每種疾病獨立預測：
- 高血壓 (Hypertension): Yes (1) / No (0)
- 高血糖 (Hyperglycemia): Yes (1) / No (0)
- 高血脂 (Dyslipidemia): Yes (1) / No (0)

### 為什麼選擇多標籤分類？

1. **臨床意義**: 三高經常共病，需要同時預測
2. **獨立預測**: 每種疾病有不同的風險因子
3. **實用性**: 醫師可針對高風險疾病進行預防介入

---

## 🔄 預測架構

### 時間窗口設計

```
Y-2 (Time 1)          Y-1 (Time 2)          Y (Time 3)
第一次檢查    →      第二次檢查    →      第三次檢查
                     (約1年後)            (約2年後)
                         ↓
                    [預測模型]
                         ↓
                   預測 Y 的三高風險
```

### 訓練樣本生成

每位病患可以產生多個訓練樣本：

```python
# 例如：某病患有 5 次檢查記錄
Times: [1, 2, 3, 4, 5]

# 可產生的訓練樣本：
Sample 1: [T1, T2] → T3
Sample 2: [T2, T3] → T4
Sample 3: [T3, T4] → T5

# 總共 3 個訓練樣本
```

---

## 📥 輸入規格 (Input Specification)

### 特徵變數 (Features)

#### 1. 時間點 Y-2 的資料

| 類別 | 變數 | 說明 | 單位 |
|------|------|------|------|
| **人口學** | Age_Y-2 | 年齡 | 歲 |
| | Sex | 性別 | 1=男, 2=女 |
| **生理測量** | BMI_Y-2 | 身體質量指數 | kg/m² |
| | SBP_Y-2 | 收縮壓 | mmHg |
| | DBP_Y-2 | 舒張壓 | mmHg |
| **血液檢驗** | FBG_Y-2 | 空腹血糖 | mmol/L |
| | TC_Y-2 | 總膽固醇 | mmol/L |
| | Cr_Y-2 | 肌酸酐 | mg/dL |
| | GFR_Y-2 | 腎絲球過濾率 | mL/min/1.73m² |
| **診斷狀態** | HTN_Y-2 | 高血壓狀態 | 0/1 |
| | HG_Y-2 | 高血糖狀態 | 0/1 |
| | DL_Y-2 | 高血脂狀態 | 0/1 |

#### 2. 時間點 Y-1 的資料

| 類別 | 變數 | 說明 |
|------|------|------|
| **生理測量** | BMI_Y-1, SBP_Y-1, DBP_Y-1 | 同 Y-2 |
| **血液檢驗** | FBG_Y-1, TC_Y-1, Cr_Y-1, GFR_Y-1 | 同 Y-2 |
| **診斷狀態** | HTN_Y-1, HG_Y-1, DL_Y-1 | 同 Y-2 |

#### 3. 變化量特徵 (Δ Features)

| 變數 | 計算方式 | 說明 |
|------|---------|------|
| **Δ_BMI** | BMI_Y-1 - BMI_Y-2 | BMI 變化 |
| **Δ_SBP** | SBP_Y-1 - SBP_Y-2 | 收縮壓變化 |
| **Δ_DBP** | DBP_Y-1 - DBP_Y-2 | 舒張壓變化 |
| **Δ_FBG** | FBG_Y-1 - FBG_Y-2 | 血糖變化 |
| **Δ_TC** | TC_Y-1 - TC_Y-2 | 膽固醇變化 |
| **Δ_GFR** | GFR_Y-1 - GFR_Y-2 | 腎功能變化 |

#### 4. 時間間隔

| 變數 | 說明 |
|------|------|
| **Time_Interval** | Y-1 與 Y-2 之間的天數 |

### 總特徵數

- Y-2 特徵: 12 個
- Y-1 特徵: 9 個
- Δ 特徵: 6 個
- 時間特徵: 1 個
- **總計: 約 28 個特徵**

---

## 📤 輸出規格 (Output Specification)

### 目標變數 (Target Variables)

#### 方案 A：二元標籤（推薦）⭐

```python
# Y 時間點的診斷狀態
y_hypertension = 0 or 1   # 是否有高血壓
y_hyperglycemia = 0 or 1  # 是否有高血糖
y_dyslipidemia = 0 or 1   # 是否有高血脂
```

**定義**：
- **0 (正常)**: Y 診斷狀態為正常 (status = 1)
- **1 (異常)**: Y 診斷狀態為異常 (status = 2)

#### 方案 B：新發病標籤（可選）

```python
# 只預測「新發病」，排除 Y-2 或 Y-1 已確診者
y_new_hypertension = 0 or 1   # Y 新發高血壓
y_new_hyperglycemia = 0 or 1  # Y 新發高血糖
y_new_dyslipidemia = 0 or 1   # Y 新發高血脂
```

**定義**：
- **0**: Y 未發病 或 Y-2/Y-1 已確診
- **1**: Y 新發病（Y-2 和 Y-1 都正常，Y 異常）

#### 方案 C：風險機率（進階）

```python
# 預測 Y 發病的機率
p_hypertension = 0.0 ~ 1.0   # 高血壓風險分數
p_hyperglycemia = 0.0 ~ 1.0  # 高血糖風險分數
p_dyslipidemia = 0.0 ~ 1.0   # 高血脂風險分數
```

### 推薦方案

**方案 A（二元標籤）** 作為主要目標：
- ✅ 簡單明確
- ✅ 臨床意義清楚
- ✅ 模型容易訓練和解釋

---

## 📏 評估指標 (Evaluation Metrics)

### 1. 分類性能指標

針對每種疾病分別計算：

| 指標 | 說明 | 目標 |
|------|------|------|
| **Accuracy** | 整體準確率 | > 0.80 |
| **Precision** | 預測為陽性中真正陽性的比例 | > 0.75 |
| **Recall (Sensitivity)** | 實際陽性中被預測為陽性的比例 | > 0.70 |
| **F1-Score** | Precision 和 Recall 的調和平均 | > 0.72 |
| **AUC-ROC** | ROC 曲線下面積 | > 0.80 |

### 2. 多標籤評估

| 指標 | 說明 |
|------|------|
| **Hamming Loss** | 標籤錯誤率 |
| **Subset Accuracy** | 完全正確的樣本比例 |
| **Macro F1** | 三種疾病 F1 的平均 |
| **Micro F1** | 所有標籤的整體 F1 |

### 3. 臨床評估

| 指標 | 說明 | 重要性 |
|------|------|--------|
| **False Negative Rate** | 漏診率（實際有病但預測沒病） | ⚠️ **最重要** |
| **False Positive Rate** | 誤診率（實際沒病但預測有病） | 中等 |
| **Early Detection Rate** | 早期發現率（在 Y-1 正常但 Y 發病的案例中的預測率） | 高 |

---

## 🎲 資料分割策略

### 按病患分割（重要！）

```python
# ❌ 錯誤做法：隨機分割所有樣本
# 會導致同一病患的樣本出現在訓練集和測試集

# ✅ 正確做法：先分割病患，再取樣本
patients_train, patients_test = train_test_split(patient_ids, test_size=0.2)

train_samples = df[df['ID'].isin(patients_train)]
test_samples = df[df['ID'].isin(patients_test)]
```

### 分割比例

- **訓練集 (Training)**: 70% 的病患
- **驗證集 (Validation)**: 15% 的病患
- **測試集 (Test)**: 15% 的病患

### 為什麼要按病患分割？

避免**資料洩漏 (Data Leakage)**：
- 同一病患的不同時間點資料高度相關
- 如果 Y-2→Y-1 在訓練集，Y-1→Y 在測試集，模型可能「作弊」

---

## 🧪 實驗設計

### 基準模型 (Baseline)

1. **邏輯迴歸 (Logistic Regression)**
   - 簡單、可解釋
   - 提供基準性能

2. **隨機森林 (Random Forest)**
   - 處理非線性關係
   - 特徵重要性分析

### 進階模型

3. **XGBoost / LightGBM**
   - 梯度提升樹
   - 通常性能最好

4. **神經網路 (Neural Network)**
   - 深度學習方法
   - 可捕捉複雜模式

### 多標籤策略

**選項 A：獨立模型**
- 為每種疾病訓練獨立模型
- 優點：簡單、可針對性優化
- 缺點：忽略疾病間相關性

**選項 B：多輸出模型**
- 單一模型同時預測三種疾病
- 優點：考慮疾病共病關係
- 缺點：較複雜

**推薦**：先用選項 A，再嘗試選項 B

---

## 📊 範例：預測情境

### 案例 1：正常 → 正常 → ？

```
Y-2 (2020-01-01):
  Age=45, Sex=男, BMI=24, SBP=120, DBP=80, FBG=5.2, TC=4.5
  狀態: 全部正常

Y-1 (2021-01-01):
  Age=46, BMI=25, SBP=125, DBP=82, FBG=5.5, TC=4.8
  狀態: 全部正常

Y (2022-01-01):
  模型預測:
    - 高血壓風險: 0.15 (低風險)
    - 高血糖風險: 0.25 (低風險)
    - 高血脂風險: 0.30 (中等風險)

  實際結果: 高血脂確診
  → 模型預測成功！
```

### 案例 2：邊緣值 → 異常 → ？

```
Y-2 (2020-01-01):
  Age=55, BMI=26, SBP=128, DBP=84, FBG=5.8
  狀態: 邊緣值（pre-hypertension, pre-diabetes）

Y-1 (2021-01-01):
  Age=56, BMI=27, SBP=135, DBP=88, FBG=6.3
  狀態: 高血壓確診, 糖尿病前期

Y (2022-01-01):
  模型預測:
    - 高血壓: 1 (持續)
    - 高血糖: 0.85 (高風險)
    - 高血脂: 0.45 (中等風險)

  臨床意義: 建議積極控制血糖，預防糖尿病
```

---

## ⚠️ 挑戰與限制

### 1. 資料不平衡 (Class Imbalance)

**問題**：
- 正常案例 >> 異常案例
- 模型可能傾向預測「正常」

**解決方案**：
- SMOTE (Synthetic Minority Over-sampling)
- 調整分類閾值
- 使用 class_weight 參數

### 2. 缺失值處理

**問題**：
- 血液檢驗資料只有 ~30% 完整

**解決方案**：
- 方案 A: 只用有完整資料的樣本（可能損失樣本量）
- 方案 B: 使用插補法（KNN, MICE）
- 方案 C: 訓練兩個模型（有/無血液檢驗）

### 3. 時間間隔不一致

**問題**：
- 有的病患每年檢查，有的 2-3 年才檢查一次

**解決方案**：
- 將時間間隔作為特徵加入模型
- 標準化時間窗口（例如：1年±3個月）

### 4. 尿酸資料缺失

**問題**：
- Synthea 資料沒有 UA（尿酸）

**解決方案**：
- 使用其他特徵進行預測
- 說明為研究限制

---

## 📈 預期成果

### 模型性能目標

| 疾病 | AUC-ROC | F1-Score | Recall |
|------|---------|----------|--------|
| 高血壓 | > 0.80 | > 0.70 | > 0.70 |
| 高血糖 | > 0.75 | > 0.65 | > 0.65 |
| 高血脂 | > 0.75 | > 0.65 | > 0.65 |

### 臨床應用價值

1. **早期預警系統**
   - 識別高風險個案
   - 提前 1-2 年預測發病

2. **個人化預防**
   - 針對高風險疾病提供建議
   - 優化醫療資源分配

3. **疾病進展追蹤**
   - 監測健康指標變化趨勢
   - 評估預防措施效果

---

## 📚 相關研究參考

### 類似研究

1. **Framingham Risk Score**
   - 使用多個時間點預測心血管風險
   - 10年風險預測模型

2. **機器學習用於三高預測**
   - 使用電子病歷資料
   - XGBoost, Random Forest 常見

### 本研究特色

- ✅ 使用縱向追蹤資料（而非橫斷面）
- ✅ 多標籤預測（同時預測三種疾病）
- ✅ 考慮時間變化趨勢（Δ features）

---

## 🎯 總結

### 核心問題

**「基於前兩次健康檢查的結果，預測第三次檢查時是否會發展出三高」**

### 關鍵特點

1. **多標籤二元分類問題**
2. **使用時間序列特徵**（Y-2, Y-1, Δ）
3. **考慮疾病進展過程**
4. **臨床可解釋性**

### 研究價值

- 💊 **預防醫學**: 早期識別高風險族群
- 📊 **精準醫療**: 個人化風險評估
- 🏥 **資源優化**: 優先追蹤高風險個案

---

*文件建立: 2025-09-30*
*準備回應 Meeting 14 Q1*