================================================================================
03_ModelBuilding.ipynb - 完整執行結果
================================================================================


--------------------------------------------------------------------------------
[Cell 0] # 機器學習模型建立 - 三高預測
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
[Cell 1] ## 1. 載入套件與資料
--------------------------------------------------------------------------------
套件載入成功！

✅ 資料載入成功！
資料形狀: 6,056 人, 107 個欄位

欄位預覽:
['ID', 'sex', 'Age', 'FBG_T1', 'TC_T1', 'Cr_T1', 'UA_T1', 'GFR_T1', 'BMI_T1', 'SBP_T1']


--------------------------------------------------------------------------------
[Cell 4] ## 2. 準備特徵和目標變數
--------------------------------------------------------------------------------
特徵總數: 26 個
  - 人口統計: 2 個
  - T1 特徵: 8 個
  - T2 特徵: 8 個
  - Δ1 特徵: 8 個

目標變數分佈:

高血壓 (hypertension_T3):
1    5046
2    1010
Name: hypertension_T3, dtype: int64
  患病率: 16.68%

高血糖 (hyperglycemia_T3):
1    5721
2     335
Name: hyperglycemia_T3, dtype: int64
  患病率: 5.53%

高血脂 (dyslipidemia_T3):
1    5695
2     361
Name: dyslipidemia_T3, dtype: int64
  患病率: 5.96%


--------------------------------------------------------------------------------
[Cell 7] ## 3. 資料分割與標準化
--------------------------------------------------------------------------------
✅ 資料分割完成（使用統一索引）
訓練集: 4844 人
測試集: 1212 人
特徵數: 26 個

✅ 特徵標準化完成
訓練集形狀: (4844, 26)
測試集形狀: (1212, 26)


--------------------------------------------------------------------------------
[Cell 10] ## 4. 建立 Baseline 模型 - Logistic Regression
--------------------------------------------------------------------------------

############################################################
#                    高血壓預測模型                        #
############################################################

============================================================
高血壓 (Hypertension) - Logistic Regression
============================================================
準確率 (Accuracy):  0.835
精確率 (Precision): 0.571
召回率 (Recall):    0.040
F1 分數:            0.074
AUC:                0.747

混淆矩陣:
預測 →    正常  患病
實際 ↓
正常      1004     6
患病       194     8


############################################################
#                    高血糖預測模型                        #
############################################################

============================================================
高血糖 (Hyperglycemia) - Logistic Regression
============================================================
準確率 (Accuracy):  0.950
精確率 (Precision): 0.703
召回率 (Recall):    0.342
F1 分數:            0.460
AUC:                0.929

混淆矩陣:
預測 →    正常  患病
實際 ↓
正常      1125    11
患病        50    26


############################################################
#                    高血脂預測模型                        #
############################################################

============================================================
高血脂 (Dyslipidemia) - Logistic Regression
============================================================
準確率 (Accuracy):  0.934
精確率 (Precision): 0.400
召回率 (Recall):    0.051
F1 分數:            0.091
AUC:                0.888

混淆矩陣:
預測 →    正常  患病
實際 ↓
正常      1128     6
患病        74     4


--------------------------------------------------------------------------------
[Cell 15] ## 5. 處理資料不平衡
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
[Cell 16] ### 5.1 問題發現：嚴重的類別不平衡
--------------------------------------------------------------------------------
======================================================================
訓練集類別分佈分析
======================================================================

高血壓:
  正常 (0): 4,036 人 (83.3%)
  患病 (1): 808 人 (16.7%)
  不平衡比率: 5.0 : 1
  ✓ 相對平衡

高血糖:
  正常 (0): 4,585 人 (94.7%)
  患病 (1): 259 人 (5.3%)
  不平衡比率: 17.7 : 1
  ⚠️ 嚴重不平衡！

高血脂:
  正常 (0): 4,561 人 (94.2%)
  患病 (1): 283 人 (5.8%)
  不平衡比率: 16.1 : 1
  ⚠️ 嚴重不平衡！


✅ 圖表已儲存至：docs/experiments/class_imbalance_distribution.png


--------------------------------------------------------------------------------
[Cell 19] ### 5.2 解決方案 1：使用 class_weight='balanced'
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
[Cell 20] #### 5.2.1 Logistic Regression with class_weight='balanced'
--------------------------------------------------------------------------------
======================================================================
Logistic Regression with class_weight='balanced'
======================================================================

高血壓:
  AUC:       0.749
  F1:        0.425
  Precision: 0.300
  Recall:    0.728

高血糖:
  AUC:       0.931
  F1:        0.470
  Precision: 0.330
  Recall:    0.816

高血脂:
  AUC:       0.888
  F1:        0.323
  Precision: 0.201
  Recall:    0.833


--------------------------------------------------------------------------------
[Cell 22] #### 5.2.2 Random Forest with class_weight='balanced'
--------------------------------------------------------------------------------
======================================================================
Random Forest with class_weight='balanced'
======================================================================

高血壓:
  AUC:       0.796
  F1:        0.065
  Precision: 0.500
  Recall:    0.035

高血糖:
  AUC:       0.892
  F1:        0.263
  Precision: 0.565
  Recall:    0.171

高血脂:
  AUC:       0.868
  F1:        0.140
  Precision: 0.750
  Recall:    0.077


--------------------------------------------------------------------------------
[Cell 24] ### 5.3 解決方案 2：使用 SMOTE 過採樣
--------------------------------------------------------------------------------
Requirement already satisfied: imbalanced-learn==0.11.0 in c:\users\joechiboo\appdata\local\anaconda3\envs\ai\lib\site-packages (0.11.0)
Requirement already satisfied: scikit-learn>=1.0.2 in c:\users\joechiboo\appdata\local\anaconda3\envs\ai\lib\site-packages (from imbalanced-learn==0.11.0) (1.0.2)
Requirement already satisfied: numpy>=1.17.3 in c:\users\joechiboo\appdata\local\anaconda3\envs\ai\lib\site-packages (from imbalanced-learn==0.11.0) (1.21.5)
Requirement already satisfied: joblib>=1.1.1 in c:\users\joechiboo\appdata\local\anaconda3\envs\ai\lib\site-packages (from imbalanced-learn==0.11.0) (1.1.1)
Requirement already satisfied: threadpoolctl>=2.0.0 in c:\users\joechiboo\appdata\local\anaconda3\envs\ai\lib\site-packages (from imbalanced-learn==0.11.0) (2.2.0)
Requirement already satisfied: scipy>=1.5.0 in c:\users\joechiboo\appdata\local\anaconda3\envs\ai\lib\site-packages (from imbalanced-learn==0.11.0) (1.7.3)

======================================================================
使用 SMOTE 過採樣 + Logistic Regression
======================================================================

高血壓:
  原始訓練集: 4844 樣本
  SMOTE 後:   8072 樣本
  類別分佈 - 正常: 4036, 患病: 4036

  效能指標:
    AUC:       0.748
    F1:        0.409
    Precision: 0.292
    Recall:    0.683

高血糖:
  原始訓練集: 4844 樣本
  SMOTE 後:   9170 樣本
  類別分佈 - 正常: 4585, 患病: 4585

  效能指標:
    AUC:       0.931
    F1:        0.490
    Precision: 0.348
    Recall:    0.829

高血脂:
  原始訓練集: 4844 樣本
  SMOTE 後:   9122 樣本
  類別分佈 - 正常: 4561, 患病: 4561

  效能指標:
    AUC:       0.887
    F1:        0.340
    Precision: 0.215
    Recall:    0.821


--------------------------------------------------------------------------------
[Cell 27] ### 5.4 比較不同平衡方法的效果
--------------------------------------------------------------------------------
================================================================================
不同平衡方法效能比較
================================================================================
 疾病                           方法      AUC       F1   Recall
高血壓               Baseline (無處理) 0.747471 0.074074 0.039604
高血壓 LR + class_weight='balanced' 0.748608 0.424855 0.727723
高血壓 RF + class_weight='balanced' 0.796351 0.064815 0.034653
高血壓                   LR + SMOTE 0.747843 0.409496 0.683168
高血糖               Baseline (無處理) 0.928987 0.460177 0.342105
高血糖 LR + class_weight='balanced' 0.931303 0.469697 0.815789
高血糖 RF + class_weight='balanced' 0.891667 0.262626 0.171053
高血糖                   LR + SMOTE 0.930944 0.490272 0.828947
高血脂               Baseline (無處理) 0.888007 0.090909 0.051282
高血脂 LR + class_weight='balanced' 0.887984 0.323383 0.833333
高血脂 RF + class_weight='balanced' 0.868154 0.139535 0.076923
高血脂                   LR + SMOTE 0.887351 0.340426 0.820513

================================================================================
最佳方法總結
================================================================================

高血壓:
  最佳 AUC:    RF + class_weight='balanced'   (AUC=0.796)
  最佳 F1:     LR + class_weight='balanced'   (F1=0.425)
  最佳 Recall: LR + class_weight='balanced'   (Recall=0.728)

高血糖:
  最佳 AUC:    LR + class_weight='balanced'   (AUC=0.931)
  最佳 F1:     LR + SMOTE                     (F1=0.490)
  最佳 Recall: LR + SMOTE                     (Recall=0.829)

高血脂:
  最佳 AUC:    Baseline (無處理)                 (AUC=0.888)
  最佳 F1:     LR + SMOTE                     (F1=0.340)
  最佳 Recall: LR + class_weight='balanced'   (Recall=0.833)


✅ 比較圖表已儲存至: docs/experiments/imbalance_methods_comparison.png


--------------------------------------------------------------------------------
[Cell 30] ## 6. 準備 Multi-Task Learning (MTL) 資料
--------------------------------------------------------------------------------
======================================================================
Multi-Task Learning 資料準備完成
======================================================================

訓練集 Multi-task 目標形狀: (4844, 3)
測試集 Multi-task 目標形狀: (1212, 3)

每個樣本包含 3 個目標變數: [高血壓, 高血糖, 高血脂]

範例（前 5 個訓練樣本）:
    樣本     高血壓     高血糖     高血脂
-----------------------------------
     1       0       0       0
     2       0       0       0
     3       1       1       0
     4       0       0       0
     5       0       1       0

✅ MTL 資料已準備完成，可以開始訓練多工學習模型！


--------------------------------------------------------------------------------
[Cell 32] ## 7. MTL 方法 1 - MultiOutputClassifier
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
[Cell 33] ### 7.1 MTL Logistic Regression (without balancing)
--------------------------------------------------------------------------------
======================================================================
MTL 方法 1: MultiOutputClassifier + Logistic Regression
======================================================================

效能評估:
----------------------------------------------------------------------

高血壓:
  AUC:       0.747
  F1:        0.074
  Precision: 0.571
  Recall:    0.040
  混淆矩陣: TN=1004, FP=6, FN=194, TP=8

高血糖:
  AUC:       0.929
  F1:        0.460
  Precision: 0.703
  Recall:    0.342
  混淆矩陣: TN=1125, FP=11, FN=50, TP=26

高血脂:
  AUC:       0.888
  F1:        0.091
  Precision: 0.400
  Recall:    0.051
  混淆矩陣: TN=1128, FP=6, FN=74, TP=4

✅ MTL Logistic Regression 訓練完成！


--------------------------------------------------------------------------------
[Cell 35] ### 7.2 MTL Random Forest (native multi-output)
--------------------------------------------------------------------------------
======================================================================
MTL 方法 1: Random Forest (native multi-output)
======================================================================

效能評估:
----------------------------------------------------------------------

高血壓:
  AUC:       0.796
  F1:        0.105
  Precision: 0.444
  Recall:    0.059
  混淆矩陣: TN=995, FP=15, FN=190, TP=12

高血糖:
  AUC:       0.897
  F1:        0.521
  Precision: 0.721
  Recall:    0.408
  混淆矩陣: TN=1124, FP=12, FN=45, TP=31

高血脂:
  AUC:       0.844
  F1:        0.073
  Precision: 0.750
  Recall:    0.038
  混淆矩陣: TN=1133, FP=1, FN=75, TP=3

✅ MTL Random Forest 訓練完成！


--------------------------------------------------------------------------------
[Cell 37] ## 8. MTL 方法 2 - ClassifierChain
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
[Cell 38] ### 8.1 ClassifierChain with Logistic Regression
--------------------------------------------------------------------------------
======================================================================
MTL 方法 2: ClassifierChain + Logistic Regression
======================================================================

效能評估:
----------------------------------------------------------------------

高血壓:
  AUC:       0.747
  F1:        0.074
  Precision: 0.571
  Recall:    0.040
  混淆矩陣: TN=1004, FP=6, FN=194, TP=8

高血糖:
  AUC:       0.930
  F1:        0.432
  Precision: 0.686
  Recall:    0.316
  混淆矩陣: TN=1125, FP=11, FN=52, TP=24

高血脂:
  AUC:       0.888
  F1:        0.091
  Precision: 0.400
  Recall:    0.051
  混淆矩陣: TN=1128, FP=6, FN=74, TP=4

✅ ClassifierChain + Logistic Regression 訓練完成！


--------------------------------------------------------------------------------
[Cell 40] ### 8.2 ClassifierChain with Random Forest
--------------------------------------------------------------------------------
======================================================================
MTL 方法 2: ClassifierChain + Random Forest
======================================================================

效能評估:
----------------------------------------------------------------------

高血壓:
  AUC:       0.792
  F1:        0.065
  Precision: 0.500
  Recall:    0.035
  混淆矩陣: TN=1003, FP=7, FN=195, TP=7

高血糖:
  AUC:       0.906
  F1:        0.474
  Precision: 0.711
  Recall:    0.355
  混淆矩陣: TN=1125, FP=11, FN=49, TP=27

高血脂:
  AUC:       0.863
  F1:        0.138
  Precision: 0.667
  Recall:    0.077
  混淆矩陣: TN=1131, FP=3, FN=72, TP=6

✅ ClassifierChain + Random Forest 訓練完成！


--------------------------------------------------------------------------------
[Cell 42] ## 9. MTL with class_weight='balanced'
--------------------------------------------------------------------------------

--------------------------------------------------------------------------------
[Cell 43] ### 9.1 MTL Logistic Regression with balanced weights
--------------------------------------------------------------------------------
======================================================================
MTL Logistic Regression with class_weight='balanced'
======================================================================

效能評估:
----------------------------------------------------------------------

高血壓:
  AUC:       0.749
  F1:        0.425
  Precision: 0.300
  Recall:    0.728
  混淆矩陣: TN=667, FP=343, FN=55, TP=147

高血糖:
  AUC:       0.931
  F1:        0.470
  Precision: 0.330
  Recall:    0.816
  混淆矩陣: TN=1010, FP=126, FN=14, TP=62

高血脂:
  AUC:       0.888
  F1:        0.323
  Precision: 0.201
  Recall:    0.833
  混淆矩陣: TN=875, FP=259, FN=13, TP=65

✅ MTL LR (balanced) 訓練完成！


--------------------------------------------------------------------------------
[Cell 45] ### 9.2 MTL Random Forest with balanced weights
--------------------------------------------------------------------------------
======================================================================
MTL Random Forest with class_weight='balanced'
======================================================================

效能評估:
----------------------------------------------------------------------

高血壓:
  AUC:       0.787
  F1:        0.010
  Precision: 1.000
  Recall:    0.005
  混淆矩陣: TN=1010, FP=0, FN=201, TP=1

高血糖:
  AUC:       0.914
  F1:        0.198
  Precision: 0.600
  Recall:    0.118
  混淆矩陣: TN=1130, FP=6, FN=67, TP=9

高血脂:
  AUC:       0.873
  F1:        0.025
  Precision: 1.000
  Recall:    0.013
  混淆矩陣: TN=1134, FP=0, FN=77, TP=1

✅ MTL RF (balanced) 訓練完成！


--------------------------------------------------------------------------------
[Cell 47] ### 9.3 ClassifierChain with balanced weights
--------------------------------------------------------------------------------
======================================================================
ClassifierChain with class_weight='balanced'
======================================================================

效能評估:
----------------------------------------------------------------------

高血壓:
  AUC:       0.796
  F1:        0.065
  Precision: 0.500
  Recall:    0.035
  混淆矩陣: TN=1003, FP=7, FN=195, TP=7

高血糖:
  AUC:       0.909
  F1:        0.227
  Precision: 0.524
  Recall:    0.145
  混淆矩陣: TN=1126, FP=10, FN=65, TP=11

高血脂:
  AUC:       0.866
  F1:        0.049
  Precision: 0.667
  Recall:    0.026
  混淆矩陣: TN=1133, FP=1, FN=76, TP=2

✅ ClassifierChain (balanced) 訓練完成！


--------------------------------------------------------------------------------
[Cell 49] ### 9.4 MTL 方法比較與視覺化
--------------------------------------------------------------------------------
================================================================================
MTL 方法效能比較
================================================================================
                 方法  疾病      AUC       F1   Recall
             MTL LR 高血壓 0.747471 0.074074 0.039604
             MTL LR 高血糖 0.928987 0.460177 0.342105
             MTL LR 高血脂 0.888007 0.090909 0.051282
             MTL RF 高血壓 0.795591 0.104803 0.059406
             MTL RF 高血糖 0.896521 0.521008 0.407895
             MTL RF 高血脂 0.843966 0.073171 0.038462
           Chain LR 高血壓 0.747471 0.074074 0.039604
           Chain LR 高血糖 0.929925 0.432432 0.315789
           Chain LR 高血脂 0.887860 0.090909 0.051282
           Chain RF 高血壓 0.792263 0.064815 0.034653
           Chain RF 高血糖 0.906447 0.473684 0.355263
           Chain RF 高血脂 0.862767 0.137931 0.076923
  MTL LR (balanced) 高血壓 0.748608 0.424855 0.727723
  MTL LR (balanced) 高血糖 0.931303 0.469697 0.815789
  MTL LR (balanced) 高血脂 0.887984 0.323383 0.833333
  MTL RF (balanced) 高血壓 0.787388 0.009852 0.004950
  MTL RF (balanced) 高血糖 0.914300 0.197802 0.118421
  MTL RF (balanced) 高血脂 0.873157 0.025316 0.012821
Chain RF (balanced) 高血壓 0.796351 0.064815 0.034653
Chain RF (balanced) 高血糖 0.908914 0.226804 0.144737
Chain RF (balanced) 高血脂 0.866453 0.049383 0.025641

================================================================================
最佳 MTL 方法總結
================================================================================

高血壓:
  最佳 AUC:    Chain RF (balanced)       (AUC=0.796)
  最佳 F1:     MTL LR (balanced)         (F1=0.425)
  最佳 Recall: MTL LR (balanced)         (Recall=0.728)

高血糖:
  最佳 AUC:    MTL LR (balanced)         (AUC=0.931)
  最佳 F1:     MTL RF                    (F1=0.521)
  最佳 Recall: MTL LR (balanced)         (Recall=0.816)

高血脂:
  最佳 AUC:    MTL LR                    (AUC=0.888)
  最佳 F1:     MTL LR (balanced)         (F1=0.323)
  最佳 Recall: MTL LR (balanced)         (Recall=0.833)


✅ MTL 比較圖表已儲存至: docs/experiments/mtl_methods_comparison.png


================================================================================
MTL 計算效益分析
================================================================================

1. 訓練時間比較
--------------------------------------------------------------------------------
LR Single-Task: 0.044 秒
LR MTL: 0.039 秒
MTL 相對速度: 1.14x

RF Single-Task: 1.037 秒
RF MTL: 18.538 秒
MTL 相對速度: 0.06x

2. 推論時間比較
--------------------------------------------------------------------------------
LR Single-Task: 0.0020 秒
LR MTL: 0.0010 秒

RF Single-Task: 0.3389 秒
RF MTL: 0.3269 秒

3. 模型大小比較
--------------------------------------------------------------------------------
LR Single-Task: 3.08 KB
LR MTL: 2.15 KB (節省 30.3%)

RF Single-Task: 14130.43 KB
RF MTL: 14153.75 KB (節省 -0.2%)

================================================================================
綜合比較表
================================================================================
模型          方法  訓練時間 (秒)  推論時間 (秒)    模型大小 (KB)
LR Single-Task  0.043949  0.002000     3.084961
LR         MTL  0.038519  0.001000     2.149414
RF Single-Task  1.037434  0.338873 14130.430664
RF         MTL 18.537916  0.326882 14153.745117


✅ 結果已儲存至: ../../results/mtl_efficiency/LR_RF_efficiency_20251208_172033.txt

'../../results/mtl_efficiency/LR_RF_efficiency_20251208_172033.txt'

--------------------------------------------------------------------------------
[Cell 54] ## 10. 比較不同特徵組合的效果
--------------------------------------------------------------------------------

================================================================================
比較不同特徵組合 - 高血壓預測
================================================================================

只用 T1 特徵 (10 個特徵):
  AUC: 0.747
  F1:  0.019

T1 + Δ1 特徵 (18 個特徵):
  AUC: 0.747
  F1:  0.074

完整特徵 (T1+T2+Δ1) (26 個特徵):
  AUC: 0.747
  F1:  0.074


--------------------------------------------------------------------------------
[Cell 56] ## 11. 視覺化模型效能比較
--------------------------------------------------------------------------------

✅ 圖表已儲存至: docs/experiments/model_performance_comparison.png


--------------------------------------------------------------------------------
[Cell 58] ## 12. 嘗試 Random Forest 模型
--------------------------------------------------------------------------------

############################################################
#               Random Forest 模型測試                   #
############################################################

============================================================
高血壓 (Hypertension) - Random Forest
============================================================
準確率 (Accuracy):  0.833
精確率 (Precision): 0.500
召回率 (Recall):    0.035
F1 分數:            0.065
AUC:                0.792

混淆矩陣:
預測 →    正常  患病
實際 ↓
正常      1003     7
患病       195     7

============================================================
模型比較總結 - 高血壓預測
============================================================

Logistic Regression:
  AUC: 0.747
  F1:  0.074

Random Forest:
  AUC: 0.792
  F1:  0.065

改善幅度:
  AUC: +4.5%
  F1:  -0.9%


--------------------------------------------------------------------------------
[Cell 60] ## 13. 特徵重要性分析
--------------------------------------------------------------------------------
============================================================
特徵重要性排名 (Top 15)
============================================================
SBP_T1               0.0918
SBP_T2               0.0628
Delta1_SBP           0.0570
Delta1_GFR           0.0444
GFR_T1               0.0432
Delta1_BMI           0.0416
Delta1_FBG           0.0412
FBG_T1               0.0407
UA_T1                0.0397
Delta1_TC            0.0396
GFR_T2               0.0393
BMI_T1               0.0390
DBP_T1               0.0386
BMI_T2               0.0376
FBG_T2               0.0368


✅ 圖表已儲存至: docs/experiments/feature_importance.png


--------------------------------------------------------------------------------
[Cell 62] ## 14. 總結與分析報告
--------------------------------------------------------------------------------