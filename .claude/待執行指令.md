# 待執行指令

> 更新日期：2026-01-12

---

## 1. 滑動窗口資料集 ✅ 已完成

```bash
python scripts/create_sliding_window_dataset.py
```

**結果**：
- 輸出：`data/01_primary/SUA/processed/SUA_sliding_window.csv`
- 樣本數：13,514 筆（原本 6,056 筆，增加 2.23 倍）

---

## 2. 修改實驗 Notebook 的 Train/Test Split ⚠️ 待執行

### 問題
目前用 `StratifiedKFold`，會讓同一個人的多筆樣本同時出現在 train 和 test，造成 data leakage。

### 解決方案
改用 `StratifiedGroupKFold`（sklearn >= 1.0）或自己實作。

### 需要修改的程式碼

**原本** (13_5FoldCV_Model_Comparison.ipynb, cell-5):
```python
cv = StratifiedKFold(n_splits=n_splits, shuffle=True, random_state=random_state)

for fold, (train_idx, test_idx) in enumerate(cv.split(X, y)):
    ...
```

**改成**:
```python
from sklearn.model_selection import StratifiedGroupKFold

# groups = patient_id (from sliding window dataset)
groups = df['patient_id']

cv = StratifiedGroupKFold(n_splits=n_splits, shuffle=True, random_state=random_state)

for fold, (train_idx, test_idx) in enumerate(cv.split(X, y, groups)):
    ...
```

### 新資料集欄位
- `patient_id`: 患者 ID（用於 GroupKFold）
- `window_start`: 窗口起始位置（1, 2, 3...）
- `window_id`: 唯一識別碼
- `*_Tinput1`: 第一個時間點特徵
- `*_Tinput2`: 第二個時間點特徵
- `Delta_*`: 變化量特徵
- `*_target`: 預測目標

---

## 3. 更新 Problem Definition

滑動窗口改變了問題定義：
- 輸入不再是固定的 T1+T2
- 而是任意連續的 (T_i, T_{i+1}) 預測 T_{i+2}

需要更新 `docs/01_thesis/chapters/第二章_問題定義.md`

---

## 4. 重跑實驗優先順序

1. **5-Fold CV Model Comparison** - 使用新資料集 + GroupKFold
2. **Delta Ablation** - 驗證 Delta 特徵在滑動窗口下的效果
3. **SHAP Analysis** - 重新分析特徵重要性
4. **PySR** - 重新搜索公式

---

## 注意事項

### Data Leakage 風險
同一個人的多筆樣本有相關性，必須確保：
- 訓練時：同一人的所有樣本都在 train
- 測試時：同一人的所有樣本都在 test
- **絕對不能混在一起**

### 驗證方式
```python
# 確認沒有 leakage
train_patients = set(df.iloc[train_idx]['patient_id'])
test_patients = set(df.iloc[test_idx]['patient_id'])
assert len(train_patients & test_patients) == 0, "Data leakage detected!"
```
